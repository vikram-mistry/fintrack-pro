<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>FinTrack Pro - Expense Manager</title>
  
  <!-- iOS Web App Meta Tags -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="FinTrack Pro" />
  <meta name="theme-color" content="#020617" id="metaThemeColor" />
  
  <!-- App Icon for iOS Home Screen - Generated dynamically as PNG -->
  <link rel="apple-touch-icon" id="appIcon" href="" />
  
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      color-scheme: dark;
    }
    [data-theme="light"] {
      color-scheme: light;
    }
    body {
      min-height: 100vh;
      background: radial-gradient(circle at top, #1f2937 0, #020617 55%, #000 100%);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      transition: background 0.3s ease;
    }
    [data-theme="light"] body {
      background: radial-gradient(circle at top, #e0f2fe 0, #f0f9ff 55%, #ffffff 100%);
    }
    [data-theme="light"] .glass {
      background: radial-gradient(circle at top left, rgba(255, 255, 255, 0.85), rgba(241, 245, 249, 0.9));
      border: 1px solid rgba(148, 163, 184, 0.3);
      box-shadow: 0 18px 40px rgba(100, 116, 139, 0.15);
    }
    [data-theme="light"] .glass-soft {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(241, 245, 249, 0.95));
      border: 1px solid rgba(148, 163, 184, 0.25);
      box-shadow: 0 14px 30px rgba(100, 116, 139, 0.12);
    }
    [data-theme="light"] .tab-glass {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 252, 0.9));
      border-top: 1px solid rgba(148, 163, 184, 0.25);
    }
    [data-theme="light"] .text-slate-100 {
      color: #1e293b;
    }
    [data-theme="light"] .text-slate-400 {
      color: #64748b;
    }
    [data-theme="light"] .text-slate-300 {
      color: #475569;
    }
    [data-theme="light"] .bg-slate-950\/70 {
      background-color: rgba(248, 250, 252, 0.9);
    }
    [data-theme="light"] .border-slate-700\/80 {
      border-color: rgba(203, 213, 225, 0.8);
    }
    [data-theme="light"] .bg-slate-800\/80 {
      background-color: rgba(226, 232, 240, 0.8);
    }
    [data-theme="light"] .bg-slate-900 {
      background-color: #f1f5f9;
    }
    [data-theme="light"] input,
    [data-theme="light"] select {
      color: #1e293b;
    }
    [data-theme="light"] input::placeholder {
      color: #94a3b8;
    }
    /* Light mode - Better visibility for income/expense colors */
    [data-theme="light"] .text-emerald-200\/90,
    [data-theme="light"] .text-emerald-300,
    [data-theme="light"] .text-emerald-400 {
      color: #059669 !important;
    }
    [data-theme="light"] .text-rose-200\/90,
    [data-theme="light"] .text-rose-300,
    [data-theme="light"] .text-rose-400 {
      color: #dc2626 !important;
    }
    [data-theme="light"] .text-amber-200,
    [data-theme="light"] .text-amber-300 {
      color: #d97706 !important;
    }
    [data-theme="light"] .text-sky-300 {
      color: #0284c7 !important;
    }
    /* Light mode - Net Worth card text visibility */
    [data-theme="light"] .text-slate-300\/80 {
      color: #334155;
    }
    /* Light mode - Badge colors */
    [data-theme="light"] .bg-emerald-500\/15 {
      background-color: rgba(16, 185, 129, 0.2);
    }
    [data-theme="light"] .border-emerald-400\/40 {
      border-color: rgba(16, 185, 129, 0.6);
    }
    [data-theme="light"] .bg-rose-500\/15 {
      background-color: rgba(220, 38, 38, 0.2);
    }
    [data-theme="light"] .border-rose-400\/40 {
      border-color: rgba(220, 38, 38, 0.6);
    }
    [data-theme="light"] .bg-amber-500\/20 {
      background-color: rgba(217, 119, 6, 0.2);
    }
    [data-theme="light"] .border-amber-400\/40 {
      border-color: rgba(217, 119, 6, 0.6);
    }
    /* Light mode - Archive section white background */
    [data-theme="light"] .bg-slate-950\/40 {
      background-color: rgba(255, 255, 255, 0.95) !important;
    }
    /* Light mode - "This month" text visibility */
    [data-theme="light"] .text-slate-100\/90 {
      color: #1e293b !important;
    }
    /* Light mode - Add entry tabs inactive state */
    [data-theme="light"] .bg-slate-900\/40 {
      background-color: rgba(255, 255, 255, 0.9) !important;
    }
    [data-theme="light"] .text-slate-200\/80 {
      color: #334155 !important;
    }
    [data-theme="light"] .border-slate-600\/80 {
      border-color: rgba(203, 213, 225, 0.8) !important;
    }
    /* Light mode - Expense tab active text darker */
    [data-theme="light"] .text-rose-50 {
      color: #7f1d1d !important;
    }
    /* Light mode - Income tab active text darker */
    [data-theme="light"] .text-emerald-50 {
      color: #065f46 !important;
    }
    /* Light mode - Transfer tab active text darker */
    [data-theme="light"] .text-sky-50 {
      color: #075985 !important;
    }
    .app-title {
      font-family: 'Outfit', sans-serif;
      background: linear-gradient(135deg, #38bdf8 0%, #34d399 50%, #a78bfa 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 0 40px rgba(56, 189, 248, 0.3);
    }
    .glass {
      backdrop-filter: blur(24px);
      -webkit-backdrop-filter: blur(24px);
      background: radial-gradient(circle at top left, rgba(148, 163, 184, 0.25), rgba(15, 23, 42, 0.85));
      border: 1px solid rgba(148, 163, 184, 0.25);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.75);
    }
    .glass-soft {
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      background: linear-gradient(135deg, rgba(30, 64, 175, 0.16), rgba(15, 23, 42, 0.85));
      border: 1px solid rgba(148, 163, 184, 0.2);
      box-shadow: 0 14px 30px rgba(15, 23, 42, 0.7);
    }
    .tab-glass {
      backdrop-filter: blur(26px);
      -webkit-backdrop-filter: blur(26px);
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.92), rgba(15, 23, 42, 0.72));
      border-top: 1px solid rgba(148, 163, 184, 0.22);
    }
    .neon-ring::before {
      content: "";
      position: absolute;
      inset: -2px;
      border-radius: 9999px;
      background: conic-gradient(from 140deg, rgba(45, 212, 191, 0.8), rgba(59, 130, 246, 0.9), rgba(244, 114, 182, 0.8), rgba(45, 212, 191, 0.8));
      opacity: 0.7;
      filter: blur(12px);
      z-index: -1;
    }
    .scroll-snap-y {
      scroll-snap-type: y proximity;
    }
    .scroll-snap-start {
      scroll-snap-align: start;
    }
    .ios-safe-bottom {
      padding-bottom: env(safe-area-inset-bottom);
    }
    .ios-safe-top {
      padding-top: env(safe-area-inset-top);
    }
    .modal-overlay {
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
    }
    .masked-amount {
      filter: blur(8px);
      user-select: none;
    }
  </style>
</head>
<body class="text-slate-100 flex flex-col">
  <div class="flex-1 flex flex-col max-w-md mx-auto w-full relative overflow-hidden">
    <!-- Blurred background orbs -->
    <div class="pointer-events-none absolute inset-0 -z-10 overflow-hidden">
      <div class="absolute -top-32 -right-24 h-72 w-72 rounded-full bg-sky-500/30 blur-3xl"></div>
      <div class="absolute -bottom-32 -left-10 h-72 w-72 rounded-full bg-emerald-400/25 blur-3xl"></div>
      <div class="absolute top-40 -left-24 h-60 w-60 rounded-full bg-pink-500/25 blur-3xl"></div>
    </div>

    <!-- Status bar spacing -->
    <header class="ios-safe-top px-5 pt-3 pb-2 flex items-center justify-between">
      <div>
        <h1 class="app-title text-xl font-bold tracking-tight">FinTrack Pro</h1>
        <p class="text-xs uppercase tracking-[0.15em] text-slate-400 mt-0.5">Welcome back</p>
      </div>
      <button id="toggleMaskButton" class="relative h-10 w-10 rounded-full glass-soft flex items-center justify-center text-slate-100 border border-sky-400/40 shadow-lg shadow-sky-500/40 transition-all hover:scale-105">
        <svg id="maskIconVisible" class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
          <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
        <svg id="maskIconHidden" class="w-5 h-5 hidden" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" />
        </svg>
      </button>
    </header>

    <!-- Main content area -->
    <main id="screenContainer" class="flex-1 px-4 pb-24 ios-safe-bottom overflow-y-auto scroll-snap-y">
      <!-- HOME SCREEN -->
      <section data-screen="home" class="space-y-4 scroll-snap-start">
        <!-- Alerts Section -->
        <div id="homeAlertsSection" class="space-y-2"></div>
        
        <!-- Net worth / summary card -->
        <div class="relative">
          <div class="absolute inset-0 blur-2xl opacity-60 bg-gradient-to-tr from-emerald-500/30 via-sky-500/30 to-indigo-500/40"></div>
          <div class="relative glass rounded-3xl p-4 pt-5 border border-slate-300/15">
            <div class="flex items-center justify-between mb-4">
              <div>
                <p class="text-xs uppercase tracking-[0.18em] text-slate-300/80">Net Worth</p>
                <p id="netWorthDisplay" class="text-3xl font-semibold mt-1 tracking-tight amount-display">‚Çπ0.00</p>
              </div>
              <div class="relative h-auto px-3 py-2 rounded-2xl glass-soft flex flex-col items-end gap-0.5 text-xs text-slate-100/90 border border-slate-100/20">
                <div class="flex items-center gap-2">
                  <span class="inline-block h-2 w-2 rounded-full bg-emerald-400 shadow-[0_0_14px_rgba(52,211,153,0.9)]"></span>
                  <span id="monthLabel">This month</span>
                </div>
                <span id="dateCycleLabel" class="text-[10px] text-slate-400"></span>
              </div>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-4 text-xs">
              <div class="glass-soft rounded-2xl p-3 flex flex-col gap-1 border border-emerald-400/25">
                <div class="flex items-center justify-between text-[11px] text-emerald-200/90">
                  <span>Monthly income</span>
                  <span class="px-1.5 py-0.5 rounded-full bg-emerald-500/15 border border-emerald-400/40 text-[10px]">IN</span>
                </div>
                <p id="monthlyIncomeDisplay" class="text-lg font-semibold tracking-tight amount-display">‚Çπ0.00</p>
              </div>
              <div class="glass-soft rounded-2xl p-3 flex flex-col gap-1 border border-rose-400/25">
                <div class="flex items-center justify-between text-[11px] text-rose-200/90">
                  <span>Monthly spent</span>
                  <span class="px-1.5 py-0.5 rounded-full bg-rose-500/15 border border-rose-400/40 text-[10px]">OUT</span>
                </div>
                <p id="monthlySpentDisplay" class="text-lg font-semibold tracking-tight amount-display">‚Çπ0.00</p>
              </div>
            </div>

            <div class="h-1.5 w-full rounded-full bg-slate-800/80 overflow-hidden mb-1.5">
              <div id="burnRateBar" class="h-full w-2/5 bg-gradient-to-r from-emerald-400 via-sky-400 to-rose-400 rounded-full transition-all duration-500"></div>
            </div>
            <p id="burnRateLabel" class="text-[11px] text-slate-300/80 flex items-center justify-between">
              <span>Healthy burn rate</span>
              <span id="transactionCountLabel">0 transactions this month</span>
            </p>
          </div>
        </div>

        <!-- Recent transactions -->
        <section class="mt-4">
          <div class="flex items-center justify-between mb-2.5">
            <h2 class="text-sm font-medium tracking-tight">Recent transactions</h2>
            <button data-nav="logs" class="text-[11px] text-sky-300/90 hover:text-sky-200 transition-colors flex items-center gap-1">
              View all
              <span class="text-xs">‚Ä∫</span>
            </button>
          </div>
          <div id="recentList" class="space-y-2"></div>
          <p id="emptyRecent" class="text-xs text-slate-400 mt-3 text-center hidden">No transactions yet. Tap "Add entry" to get started.</p>
        </section>
      </section>

      <!-- LOGS SCREEN -->
      <section data-screen="logs" class="hidden scroll-snap-start">
        <header class="flex items-center justify-between mb-3 mt-1">
          <h2 class="text-base font-semibold">Logs</h2>
          <button id="exportCSVBtn" class="flex items-center gap-1.5 px-3 py-1.5 rounded-full glass-soft border border-sky-400/40 text-xs text-sky-300 hover:bg-sky-500/20 transition-all shadow-md shadow-sky-500/20">
            <span>üì•</span>
            <span>Export CSV</span>
          </button>
        </header>
        <div class="glass rounded-3xl p-3 mb-3 text-xs flex items-center gap-3">
          <select id="logsFilterType" class="bg-transparent border border-slate-500/50 rounded-2xl px-2.5 py-1 outline-none text-xs">
            <option value="all">All</option>
            <option value="income">Income</option>
            <option value="expense">Expense</option>
            <option value="transfer">Transfer</option>
          </select>
          <select id="logsFilterRange" class="bg-transparent border border-slate-500/50 rounded-2xl px-2.5 py-1 outline-none text-xs flex-1">
            <option value="month">This month</option>
            <option value="week">This week</option>
            <option value="all">All time</option>
          </select>
        </div>
        <div id="logsList" class="space-y-2 text-sm"></div>
        <p id="emptyLogs" class="text-xs text-slate-400 mt-3 text-center">No transactions yet.</p>
      </section>

      <!-- BUDGET SCREEN -->
      <section data-screen="budget" class="hidden scroll-snap-start">
        <header class="flex items-center justify-between mb-3 mt-1">
          <h2 class="text-base font-semibold">Budget</h2>
          <span class="text-[11px] text-slate-400">Monthly Overview</span>
        </header>
        <div class="glass rounded-3xl p-4 mb-3 text-sm">
          <div class="flex items-center justify-between mb-2">
            <p class="text-xs text-slate-300">Monthly budget overview</p>
            <button id="editBudgetBtn" class="p-1.5 rounded-full hover:bg-slate-700/50 text-slate-400 hover:text-sky-300 transition-colors" title="Edit Budget">
              ‚úèÔ∏è
            </button>
          </div>
          <div class="flex items-end justify-between mb-3">
            <div>
              <p class="text-[11px] text-slate-400">Planned spending</p>
              <p id="budgetPlanned" class="text-xl font-semibold amount-display">‚Çπ50,000.00</p>
            </div>
            <div class="text-right">
              <p class="text-[11px] text-slate-400">Remaining</p>
              <p id="budgetRemaining" class="text-xl font-semibold text-emerald-300 amount-display">‚Çπ50,000.00</p>
            </div>
          </div>
          <div class="h-2 rounded-full bg-slate-900 overflow-hidden mb-1">
            <div id="budgetBar" class="h-full w-0 bg-gradient-to-r from-emerald-400 via-amber-400 to-rose-400 transition-all duration-500"></div>
          </div>
          <p id="budgetLabel" class="text-[11px] text-slate-400">0% of your budget used this month.</p>
        </div>

        <div class="space-y-2 text-sm">
          <h3 class="text-xs uppercase tracking-[0.2em] text-slate-400 mb-2">Category-wise Spending</h3>
          <div id="categorySpendingList" class="space-y-2"></div>
          <p id="emptyCategorySpending" class="text-xs text-slate-400 text-center hidden">No spending this month.</p>
        </div>
      </section>

      <!-- ADD ENTRY SCREEN -->
      <section data-screen="add" class="hidden scroll-snap-start">
        <header class="flex items-center justify-between mb-3 mt-1">
          <h2 class="text-base font-semibold">Add entry</h2>
          <span class="text-[11px] text-slate-400">Quick capture</span>
        </header>
        <form id="entryForm" class="space-y-3 text-sm">
          <div class="glass rounded-3xl p-4 space-y-3">
            <div class="flex gap-2 text-xs">
              <button type="button" data-type="expense" class="typeToggle flex-1 rounded-2xl px-3 py-1.5 border border-rose-400/60 bg-rose-500/20 text-rose-50">Expense</button>
              <button type="button" data-type="income" class="typeToggle flex-1 rounded-2xl px-3 py-1.5 border border-slate-600/80 bg-slate-900/40 text-slate-200/80">Income</button>
              <button type="button" data-type="transfer" class="typeToggle flex-1 rounded-2xl px-3 py-1.5 border border-slate-600/80 bg-slate-900/40 text-slate-200/80">Transfer</button>
            </div>

            <div>
              <label class="text-xs text-slate-300 mb-1 block">Amount</label>
              <div class="flex items-center gap-2 rounded-2xl bg-slate-950/70 border border-slate-700/80 px-3 py-2">
                <span class="text-slate-500 text-xs">‚Çπ</span>
                <input id="amountInput" type="number" inputmode="decimal" step="0.01" placeholder="0.00" class="bg-transparent flex-1 outline-none text-sm" required />
              </div>
            </div>

            <div id="categoryField">
              <label class="text-xs text-slate-300 mb-1 block">Category</label>
              <select id="categoryInput" class="w-full rounded-2xl bg-slate-950/70 border border-slate-700/80 px-3 py-2 text-xs outline-none">
              </select>
            </div>

            <div id="regularAccountField" class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-xs text-slate-300 mb-1 block">Account</label>
                <select id="accountInput" class="w-full rounded-2xl bg-slate-950/70 border border-slate-700/80 px-3 py-2 text-xs outline-none">
                </select>
              </div>
              <div>
                <label class="text-xs text-slate-300 mb-1 block">Date</label>
                <input id="dateInput" type="date" class="w-full rounded-2xl bg-slate-950/70 border border-slate-700/80 px-3 py-2 text-xs outline-none" />
              </div>
            </div>
            
            <div id="transferFields" class="hidden space-y-3">
              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label class="text-xs text-slate-300 mb-1 block">From Account</label>
                  <select id="fromAccountInput" class="w-full rounded-2xl bg-slate-950/70 border border-slate-700/80 px-3 py-2 text-xs outline-none">
                  </select>
                </div>
                <div>
                  <label class="text-xs text-slate-300 mb-1 block">To Account</label>
                  <select id="toAccountInput" class="w-full rounded-2xl bg-slate-950/70 border border-slate-700/80 px-3 py-2 text-xs outline-none">
                  </select>
                </div>
              </div>
              <div>
                <label class="text-xs text-slate-300 mb-1 block">Date</label>
                <input id="transferDateInput" type="date" class="w-full rounded-2xl bg-slate-950/70 border border-slate-700/80 px-3 py-2 text-xs outline-none" />
              </div>
            </div>

            <div>
              <label class="text-xs text-slate-300 mb-1 block">Note</label>
              <input id="noteInput" type="text" placeholder="Optional" class="w-full rounded-2xl bg-slate-950/70 border border-slate-700/80 px-3 py-2 text-xs outline-none" />
            </div>

            <label class="flex items-center gap-2 text-xs text-slate-300 mt-1">
              <input id="isRecurringInput" type="checkbox" class="accent-sky-400" />
              Mark as recurring
            </label>

            <div id="recurringFields" class="hidden space-y-3">
              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label class="text-xs text-slate-300 mb-1 block">Recurring Type</label>
                  <select id="recurringTypeInput" class="w-full rounded-2xl bg-slate-950/70 border border-slate-700/80 px-3 py-2 text-xs outline-none">
                    <option value="monthly">Monthly</option>
                    <option value="weekly">Weekly</option>
                    <option value="yearly">Yearly</option>
                  </select>
                </div>
                <div>
                  <label class="text-xs text-slate-300 mb-1 block">Due Day of Month</label>
                  <input id="dueDayInput" type="number" min="1" max="31" placeholder="e.g., 5" class="w-full rounded-2xl bg-slate-950/70 border border-slate-700/80 px-3 py-2 text-xs outline-none" />
                </div>
              </div>
            </div>
          </div>

          <button type="submit" class="w-full relative rounded-full py-2.5 text-sm font-medium bg-gradient-to-r from-sky-400 via-emerald-400 to-indigo-400 text-slate-950 shadow-lg shadow-sky-500/40 active:scale-[0.985] transition-transform">
            Save entry
          </button>
        </form>
      </section>

      <!-- ACCOUNTS SCREEN -->
      <section data-screen="accounts" class="hidden scroll-snap-start">
        <header class="flex items-center justify-between mb-3 mt-1">
          <h2 class="text-base font-semibold">Accounts</h2>
          <button id="addAccountBtn" class="flex items-center gap-1.5 px-3 py-1.5 rounded-full glass-soft border border-sky-400/40 text-xs text-sky-300 hover:bg-sky-500/20 transition-all shadow-md shadow-sky-500/20">
            <span class="text-sm">+</span>
            <span>Add Account</span>
          </button>
        </header>
        <div id="accountsList" class="space-y-3 text-sm"></div>
        <p id="emptyAccounts" class="text-xs text-slate-400 mt-3 text-center hidden">No accounts yet. Add one to get started.</p>
      </section>

      <!-- RECURRING SCREEN -->
      <section data-screen="recurring" class="hidden scroll-snap-start">
        <header class="flex items-center justify-between mb-3 mt-1">
          <h2 class="text-base font-semibold">Reminders</h2>
          <span class="text-[11px] text-slate-400">Bills & Subscriptions</span>
        </header>
        <div id="recurringList" class="space-y-2 text-sm"></div>
        <p id="emptyRecurring" class="text-xs text-slate-400 mt-3 text-center">No reminders yet.</p>
      </section>

      <!-- SETTINGS SCREEN -->
      <section data-screen="settings" class="hidden scroll-snap-start">
        <header class="flex items-center justify-between mb-3 mt-1">
          <h2 class="text-base font-semibold">Settings</h2>
        </header>
        <div class="space-y-3 text-sm">
          <div class="glass rounded-3xl p-3 flex items-center justify-between">
            <div>
              <p class="text-sm">Appearance</p>
              <p id="themeLabel" class="text-[11px] text-slate-400">Dark mode with glass effects</p>
            </div>
            <button id="themeToggleBtn" class="relative w-14 h-7 rounded-full bg-slate-800 border border-slate-600/70 transition-all duration-300" title="Toggle Theme">
              <span id="themeToggleKnob" class="absolute top-0.5 left-0.5 w-6 h-6 rounded-full bg-gradient-to-r from-slate-600 to-slate-700 shadow-md transition-all duration-300 flex items-center justify-center text-xs">üåô</span>
            </button>
          </div>
          <div class="glass rounded-3xl p-3">
            <label class="text-xs text-slate-300 mb-2 block">Month Start Date</label>
            <div class="flex items-center gap-2">
              <input id="monthStartDateInput" type="number" min="1" max="31" class="w-20 rounded-2xl bg-slate-950/70 border border-slate-700/80 px-3 py-2 text-xs outline-none" />
              <span class="text-xs text-slate-400">day of month</span>
            </div>
          </div>
          
          <!-- Category Budgets Section -->
          <div class="glass rounded-3xl p-3">
            <div class="flex items-center justify-between mb-3">
              <p class="text-sm font-medium">Category Budgets</p>
              <span class="text-[10px] text-slate-400">Set limits per category</span>
            </div>
            <div id="categoryBudgetsList" class="space-y-2 max-h-64 overflow-y-auto pr-1"></div>
          </div>
          
          <!-- Transaction Archive Section -->
          <div class="glass rounded-3xl p-3">
            <div class="flex items-center justify-between mb-3">
              <p class="text-sm font-medium">Transaction Archive</p>
              <span class="text-[10px] text-slate-400">Monthly cycle backups</span>
            </div>
            <div id="archiveList" class="space-y-2 max-h-64 overflow-y-auto pr-1"></div>
            <p id="emptyArchive" class="text-xs text-slate-400 text-center py-2 hidden">No archived months yet.</p>
          </div>
          
          <div class="glass rounded-3xl p-3">
            <p class="text-xs text-slate-300 mb-2">Data Management</p>
            <div class="flex gap-3">
              <button id="resetData" class="text-xs text-rose-300 underline underline-offset-4">Reset Data</button>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Bottom Tab Bar -->
    <nav class="tab-glass ios-safe-bottom fixed bottom-0 left-0 right-0">
      <div class="max-w-md mx-auto px-4 pt-2 pb-4 flex items-center justify-around text-[11px]">
        <button data-tab="home" class="tabButton flex flex-col items-center gap-0.5 text-sky-300 flex-1">
          <span class="text-base">‚åÇ</span>
          <span>Home</span>
        </button>
        <button data-tab="logs" class="tabButton flex flex-col items-center gap-0.5 text-slate-400 flex-1">
          <span class="text-base">‚ò∞</span>
          <span>Logs</span>
        </button>
        <button data-tab="budget" class="tabButton flex flex-col items-center gap-0.5 text-slate-400 flex-1">
          <span class="text-base">‚óé</span>
          <span>Budget</span>
        </button>

        <div class="relative -mt-5 flex-1 flex justify-center">
          <button data-tab="add" class="tabButton relative neon-ring rounded-full h-12 w-12 flex items-center justify-center bg-slate-900 text-slate-100 border border-sky-400/70 shadow-xl shadow-sky-500/50">
            <span class="text-2xl leading-none mb-[2px]">Ôºã</span>
          </button>
        </div>

        <button data-tab="accounts" class="tabButton flex flex-col items-center gap-0.5 text-slate-400 flex-1">
          <span class="text-base">‚äû</span>
          <span>Accounts</span>
        </button>
        <button data-tab="recurring" class="tabButton flex flex-col items-center gap-0.5 text-slate-400 flex-1">
          <span class="text-base">‚àû</span>
          <span>Reminders</span>
        </button>
        <button data-tab="settings" class="tabButton flex flex-col items-center gap-0.5 text-slate-400 flex-1">
          <span class="text-base">‚öôÔ∏é</span>
          <span>Settings</span>
        </button>
      </div>
    </nav>

    <!-- Add Account Modal -->
    <div id="addAccountModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 modal-overlay">
      <div class="glass rounded-3xl p-5 w-full max-w-sm border border-slate-300/20">
        <h3 class="text-lg font-semibold mb-4">Add New Account</h3>
        <form id="addAccountForm" class="space-y-3">
          <div>
            <label class="text-xs text-slate-300 mb-1 block">Account Type</label>
            <select id="newAccountType" class="w-full rounded-2xl bg-slate-950/70 border border-slate-700/80 px-3 py-2 text-xs outline-none">
              <option value="bank">Bank Account</option>
              <option value="wallet">Wallet / Cash</option>
              <option value="credit">Credit Card</option>
              <option value="investment">Investment</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div>
            <label class="text-xs text-slate-300 mb-1 block">Account Name</label>
            <input id="newAccountName" type="text" placeholder="e.g., HDFC Bank, Wallet" class="w-full rounded-2xl bg-slate-950/70 border border-slate-700/80 px-3 py-2 text-sm outline-none" required />
          </div>
          <div>
            <label class="text-xs text-slate-300 mb-1 block">Initial Balance / Outstanding</label>
            <div class="flex items-center gap-2 rounded-2xl bg-slate-950/70 border border-slate-700/80 px-3 py-2">
              <span class="text-slate-500 text-xs">‚Çπ</span>
              <input id="newAccountBalance" type="number" inputmode="decimal" step="0.01" placeholder="0.00" class="bg-transparent flex-1 outline-none text-sm" value="0" />
            </div>
          </div>
          <div id="creditCardDueDateField" class="hidden">
            <label class="text-xs text-slate-300 mb-1 block">Payment Due Day (1-31)</label>
            <input id="newAccountDueDay" type="number" min="1" max="31" placeholder="e.g., 15" class="w-full rounded-2xl bg-slate-950/70 border border-slate-700/80 px-3 py-2 text-xs outline-none" />
          </div>
          <div class="flex gap-3 pt-2">
            <button type="button" id="cancelAddAccount" class="flex-1 rounded-full py-2 text-sm font-medium border border-slate-600/80 text-slate-300 hover:bg-slate-800/50 transition-colors">
              Cancel
            </button>
            <button type="submit" class="flex-1 rounded-full py-2 text-sm font-medium bg-gradient-to-r from-sky-400 via-emerald-400 to-indigo-400 text-slate-950 shadow-lg shadow-sky-500/40">
              Add Account
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Edit Account Modal -->
    <div id="editAccountModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 modal-overlay">
      <div class="glass rounded-3xl p-5 w-full max-w-sm border border-slate-300/20">
        <h3 class="text-lg font-semibold mb-4">Edit Account</h3>
        <form id="editAccountForm" class="space-y-3">
          <input type="hidden" id="editAccountOldName" />
          <div>
            <label class="text-xs text-slate-300 mb-1 block">Account Type</label>
            <select id="editAccountType" class="w-full rounded-2xl bg-slate-950/70 border border-slate-700/80 px-3 py-2 text-xs outline-none">
              <option value="bank">Bank Account</option>
              <option value="wallet">Wallet / Cash</option>
              <option value="credit">Credit Card</option>
              <option value="investment">Investment</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div>
            <label class="text-xs text-slate-300 mb-1 block">Account Name</label>
            <input id="editAccountName" type="text" class="w-full rounded-2xl bg-slate-950/70 border border-slate-700/80 px-3 py-2 text-sm outline-none" required />
          </div>
          <div>
            <label class="text-xs text-slate-300 mb-1 block">Initial Balance / Outstanding</label>
            <div class="flex items-center gap-2 rounded-2xl bg-slate-950/70 border border-slate-700/80 px-3 py-2">
              <span class="text-slate-500 text-xs">‚Çπ</span>
              <input id="editAccountBalance" type="number" inputmode="decimal" step="0.01" class="bg-transparent flex-1 outline-none text-sm" />
            </div>
          </div>
          <div id="editCreditCardDueDateField" class="hidden">
            <label class="text-xs text-slate-300 mb-1 block">Payment Due Day (1-31)</label>
            <input id="editAccountDueDay" type="number" min="1" max="31" class="w-full rounded-2xl bg-slate-950/70 border border-slate-700/80 px-3 py-2 text-xs outline-none" />
          </div>
          <div class="flex gap-3 pt-2">
            <button type="button" id="cancelEditAccount" class="flex-1 rounded-full py-2 text-sm font-medium border border-slate-600/80 text-slate-300 hover:bg-slate-800/50 transition-colors">
              Cancel
            </button>
            <button type="submit" class="flex-1 rounded-full py-2 text-sm font-medium bg-gradient-to-r from-sky-400 via-emerald-400 to-indigo-400 text-slate-950 shadow-lg shadow-sky-500/40">
              Save
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Edit Transaction Modal -->
    <div id="editTransactionModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 modal-overlay">
      <div class="glass rounded-3xl p-5 w-full max-w-sm border border-slate-300/20 max-h-[80vh] overflow-y-auto">
        <h3 class="text-lg font-semibold mb-4">Edit Transaction</h3>
        <form id="editTransactionForm" class="space-y-3">
          <input type="hidden" id="editTxId" />
          <div>
            <label class="text-xs text-slate-300 mb-1 block">Type</label>
            <select id="editTxType" class="w-full rounded-2xl bg-slate-950/70 border border-slate-700/80 px-3 py-2 text-xs outline-none">
              <option value="expense">Expense</option>
              <option value="income">Income</option>
              <option value="transfer">Transfer</option>
            </select>
          </div>
          <div>
            <label class="text-xs text-slate-300 mb-1 block">Amount</label>
            <div class="flex items-center gap-2 rounded-2xl bg-slate-950/70 border border-slate-700/80 px-3 py-2">
              <span class="text-slate-500 text-xs">‚Çπ</span>
              <input id="editTxAmount" type="number" inputmode="decimal" step="0.01" class="bg-transparent flex-1 outline-none text-sm" required />
            </div>
          </div>
          <div id="editTxCategoryField">
            <label class="text-xs text-slate-300 mb-1 block">Category</label>
            <select id="editTxCategory" class="w-full rounded-2xl bg-slate-950/70 border border-slate-700/80 px-3 py-2 text-xs outline-none">
            </select>
          </div>
          <div id="editTxRegularAccountField">
            <label class="text-xs text-slate-300 mb-1 block">Account</label>
            <select id="editTxAccount" class="w-full rounded-2xl bg-slate-950/70 border border-slate-700/80 px-3 py-2 text-xs outline-none">
            </select>
          </div>
          <div id="editTxTransferFields" class="hidden space-y-3">
            <div>
              <label class="text-xs text-slate-300 mb-1 block">From Account</label>
              <select id="editTxFromAccount" class="w-full rounded-2xl bg-slate-950/70 border border-slate-700/80 px-3 py-2 text-xs outline-none">
              </select>
            </div>
            <div>
              <label class="text-xs text-slate-300 mb-1 block">To Account</label>
              <select id="editTxToAccount" class="w-full rounded-2xl bg-slate-950/70 border border-slate-700/80 px-3 py-2 text-xs outline-none">
              </select>
            </div>
          </div>
          <div>
            <label class="text-xs text-slate-300 mb-1 block">Date</label>
            <input id="editTxDate" type="date" class="w-full rounded-2xl bg-slate-950/70 border border-slate-700/80 px-3 py-2 text-xs outline-none" />
          </div>
          <div>
            <label class="text-xs text-slate-300 mb-1 block">Note</label>
            <input id="editTxNote" type="text" class="w-full rounded-2xl bg-slate-950/70 border border-slate-700/80 px-3 py-2 text-xs outline-none" />
          </div>
          <div id="editTxRecurringContainer">
            <label class="flex items-center gap-2 text-xs text-slate-300 mt-1">
              <input id="editTxIsRecurring" type="checkbox" class="accent-sky-400" />
              Mark as recurring
            </label>
          </div>
          <div id="editTxRecurringFields" class="hidden space-y-3">
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-xs text-slate-300 mb-1 block">Recurring Type</label>
                <select id="editTxRecurringType" class="w-full rounded-2xl bg-slate-950/70 border border-slate-700/80 px-3 py-2 text-xs outline-none">
                  <option value="monthly">Monthly</option>
                  <option value="weekly">Weekly</option>
                  <option value="yearly">Yearly</option>
                </select>
              </div>
              <div>
                <label class="text-xs text-slate-300 mb-1 block">Due Day of Month</label>
                <input id="editTxDueDay" type="number" min="1" max="31" placeholder="e.g., 5" class="w-full rounded-2xl bg-slate-950/70 border border-slate-700/80 px-3 py-2 text-xs outline-none" />
              </div>
            </div>
          </div>
          <div class="flex gap-3 pt-2">
            <button type="button" id="cancelEditTx" class="flex-1 rounded-full py-2 text-sm font-medium border border-slate-600/80 text-slate-300 hover:bg-slate-800/50 transition-colors">
              Cancel
            </button>
            <button type="submit" class="flex-1 rounded-full py-2 text-sm font-medium bg-gradient-to-r from-sky-400 via-emerald-400 to-indigo-400 text-slate-950 shadow-lg shadow-sky-500/40">
              Save
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Edit Budget Modal -->
    <div id="editBudgetModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 modal-overlay">
      <div class="glass rounded-3xl p-5 w-full max-w-sm border border-slate-300/20">
        <h3 class="text-lg font-semibold mb-4">Set Monthly Budget</h3>
        <form id="editBudgetForm" class="space-y-3">
          <div>
            <label class="text-xs text-slate-300 mb-1 block">Monthly Budget Amount</label>
            <div class="flex items-center gap-2 rounded-2xl bg-slate-950/70 border border-slate-700/80 px-3 py-2">
              <span class="text-slate-500 text-xs">‚Çπ</span>
              <input id="budgetAmountInput" type="number" inputmode="decimal" step="100" min="0" class="bg-transparent flex-1 outline-none text-sm" required />
            </div>
          </div>
          <div class="flex gap-3 pt-2">
            <button type="button" id="cancelEditBudget" class="flex-1 rounded-full py-2 text-sm font-medium border border-slate-600/80 text-slate-300 hover:bg-slate-800/50 transition-colors">
              Cancel
            </button>
            <button type="submit" class="flex-1 rounded-full py-2 text-sm font-medium bg-gradient-to-r from-sky-400 via-emerald-400 to-indigo-400 text-slate-950 shadow-lg shadow-sky-500/40">
              Save
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 modal-overlay">
      <div class="glass rounded-3xl p-5 w-full max-w-sm border border-slate-300/20">
        <h3 class="text-lg font-semibold mb-2">Delete Item</h3>
        <p class="text-sm text-slate-400 mb-4">Are you sure you want to delete this item? This action cannot be undone.</p>
        <input type="hidden" id="deleteItemId" />
        <input type="hidden" id="deleteItemType" />
        <div class="flex gap-3">
          <button id="cancelDelete" class="flex-1 rounded-full py-2 text-sm font-medium border border-slate-600/80 text-slate-300 hover:bg-slate-800/50 transition-colors">
            Cancel
          </button>
          <button id="confirmDelete" class="flex-1 rounded-full py-2 text-sm font-medium bg-gradient-to-r from-rose-500 to-rose-600 text-white shadow-lg shadow-rose-500/40">
            Delete
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let isMasked = false;
    let isDarkMode = true;
    
    // Load theme from localStorage
    function loadTheme() {
      const savedTheme = localStorage.getItem("fintrack_theme");
      if (savedTheme === "light") {
        isDarkMode = false;
        document.documentElement.setAttribute("data-theme", "light");
        updateThemeUI();
      }
    }
    
    function updateThemeUI() {
      const themeLabel = document.getElementById("themeLabel");
      const themeToggleBtn = document.getElementById("themeToggleBtn");
      const themeToggleKnob = document.getElementById("themeToggleKnob");
      
      if (isDarkMode) {
        themeLabel.textContent = "Dark mode with glass effects";
        themeToggleBtn.classList.remove("bg-sky-500");
        themeToggleBtn.classList.add("bg-slate-800");
        themeToggleKnob.style.left = "2px";
        themeToggleKnob.innerHTML = "üåô";
        themeToggleKnob.classList.remove("bg-gradient-to-r", "from-amber-400", "to-yellow-500");
        themeToggleKnob.classList.add("bg-gradient-to-r", "from-slate-600", "to-slate-700");
      } else {
        themeLabel.textContent = "Light mode with glass effects";
        themeToggleBtn.classList.remove("bg-slate-800");
        themeToggleBtn.classList.add("bg-sky-500");
        themeToggleKnob.style.left = "calc(100% - 26px)";
        themeToggleKnob.innerHTML = "‚òÄÔ∏è";
        themeToggleKnob.classList.remove("bg-gradient-to-r", "from-slate-600", "to-slate-700");
        themeToggleKnob.classList.add("bg-gradient-to-r", "from-amber-400", "to-yellow-500");
      }
    }
    
    function toggleTheme() {
      isDarkMode = !isDarkMode;
      document.documentElement.setAttribute("data-theme", isDarkMode ? "dark" : "light");
      localStorage.setItem("fintrack_theme", isDarkMode ? "dark" : "light");
      // Update meta theme color for iOS status bar
      document.getElementById("metaThemeColor").setAttribute("content", isDarkMode ? "#020617" : "#f0f9ff");
      updateThemeUI();
    }
    
    // Initialize theme on load
    loadTheme();
    
    const currency = (v) => {
      if (!Number.isFinite(v)) return "‚Çπ0.00";
      return "‚Çπ" + v.toLocaleString("en-IN", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    };

    const STORAGE_KEY = "liquidGlassExpenseData_v3";

    const expenseCategories = ["Groceries", "Dining", "Transport", "Housing", "Maintenance", "EMI", "Invest", "Subscription", "Tax", "Bills", "Education", "Health", "Apparels", "Beauty", "Toys", "Electronics", "Gift", "Other"];
    const incomeCategories = ["Salary", "Cashback", "Reversal", "Gift"];
    const transferCategories = ["Transfer"];

    const initialState = {
      transactions: [],
      budgetMonthly: 50000,
      accounts: {},
      accountTypes: {},
      accountInitialBalances: {},
      accountDueDays: {},
      monthStartDate: 1,
      categories: {
        "Groceries": { type: "expense", budget: 0 },
        "Dining": { type: "expense", budget: 0 },
        "Transport": { type: "expense", budget: 0 },
        "Housing": { type: "expense", budget: 0 },
        "Salary": { type: "income", budget: 0 },
        "Cashback": { type: "income", budget: 0 },
        "Reversal": { type: "income", budget: 0 },
        "Gift": { type: "income", budget: 0 },
        "Maintenance": { type: "expense", budget: 0 },
        "EMI": { type: "expense", budget: 0 },
        "Invest": { type: "expense", budget: 0 },
        "Transfer": { type: "neutral", budget: 0 },
        "Subscription": { type: "expense", budget: 0 },
        "Tax": { type: "expense", budget: 0 },
        "Bills": { type: "expense", budget: 0 },
        "Education": { type: "expense", budget: 0 },
        "Health": { type: "expense", budget: 0 },
        "Apparels": { type: "expense", budget: 0 },
        "Beauty": { type: "expense", budget: 0 },
        "Toys": { type: "expense", budget: 0 },
        "Electronics": { type: "expense", budget: 0 },
        "Other": { type: "expense", budget: 0 }
      },
      reminderPayments: {},
      creditCardPayments: {}
    };

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return structuredClone(initialState);
        const parsed = JSON.parse(raw);
        const merged = Object.assign(structuredClone(initialState), parsed);
        for (const cat in merged.categories) {
          if (typeof merged.categories[cat].budget === 'undefined') {
            merged.categories[cat].budget = 0;
          }
        }
        if (!merged.reminderPayments) merged.reminderPayments = {};
        if (!merged.accountInitialBalances) merged.accountInitialBalances = {};
        if (!merged.accountDueDays) merged.accountDueDays = {};
        if (!merged.creditCardPayments) merged.creditCardPayments = {};
        return merged;
      } catch (e) {
        console.warn("Failed to parse stored state", e);
        return structuredClone(initialState);
      }
    }

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    let state = loadState();

    // Tab navigation
    const screenSections = document.querySelectorAll("[data-screen]");
    const tabButtons = document.querySelectorAll(".tabButton");

    function showScreen(name) {
      screenSections.forEach((sec) => {
        sec.classList.toggle("hidden", sec.dataset.screen !== name);
      });
      tabButtons.forEach((btn) => {
        const isActive = btn.dataset.tab === name;
        btn.classList.toggle("text-sky-300", isActive);
        btn.classList.toggle("text-slate-400", !isActive);
      });
    }

    tabButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const target = btn.dataset.tab;
        if (target) showScreen(target);
      });
    });

    document.querySelectorAll("[data-nav]").forEach((btn) => {
      btn.addEventListener("click", () => {
        showScreen(btn.dataset.nav);
      });
    });

    // Mask/Unmask toggle
    document.getElementById("toggleMaskButton").addEventListener("click", () => {
      isMasked = !isMasked;
      document.getElementById("maskIconVisible").classList.toggle("hidden", isMasked);
      document.getElementById("maskIconHidden").classList.toggle("hidden", !isMasked);
      applyMasking();
    });

    function applyMasking() {
      const amounts = document.querySelectorAll(".amount-display");
      amounts.forEach(el => {
        if (isMasked) {
          el.classList.add("masked-amount");
        } else {
          el.classList.remove("masked-amount");
        }
      });
    }

    // Entry form logic
    const entryForm = document.getElementById("entryForm");
    const typeToggles = document.querySelectorAll(".typeToggle");
    let currentType = "expense";

    function updateCategoryDropdown(type) {
      const categoryInput = document.getElementById("categoryInput");
      categoryInput.innerHTML = "";
      
      let categories = [];
      if (type === "expense") categories = expenseCategories;
      else if (type === "income") categories = incomeCategories;
      else if (type === "transfer") categories = transferCategories;
      
      categories.forEach(cat => {
        const opt = document.createElement("option");
        opt.value = cat;
        opt.textContent = cat;
        categoryInput.appendChild(opt);
      });
    }

    function updateFormForType(type) {
      const categoryField = document.getElementById("categoryField");
      const regularAccountField = document.getElementById("regularAccountField");
      const transferFields = document.getElementById("transferFields");
      const isRecurringInput = document.getElementById("isRecurringInput");
      const recurringFields = document.getElementById("recurringFields");
      
      if (type === "transfer") {
        categoryField.classList.add("hidden");
        regularAccountField.classList.add("hidden");
        transferFields.classList.remove("hidden");
        // Keep recurring option visible for transfers now
        isRecurringInput.parentElement.classList.remove("hidden");
      } else {
        categoryField.classList.remove("hidden");
        regularAccountField.classList.remove("hidden");
        transferFields.classList.add("hidden");
        isRecurringInput.parentElement.classList.remove("hidden");
      }
      
      updateCategoryDropdown(type);
    }

    typeToggles.forEach((btn) => {
      btn.addEventListener("click", () => {
        currentType = btn.dataset.type;
        typeToggles.forEach((b) => {
          const active = b.dataset.type === currentType;
          if (active) {
            if (currentType === "expense") {
              b.className = "typeToggle flex-1 rounded-2xl px-3 py-1.5 border border-rose-400/60 bg-rose-500/20 text-rose-50";
            } else if (currentType === "income") {
              b.className = "typeToggle flex-1 rounded-2xl px-3 py-1.5 border border-emerald-400/60 bg-emerald-500/20 text-emerald-50";
            } else {
              b.className = "typeToggle flex-1 rounded-2xl px-3 py-1.5 border border-sky-400/60 bg-sky-500/20 text-sky-50";
            }
          } else {
            b.className = "typeToggle flex-1 rounded-2xl px-3 py-1.5 border border-slate-600/80 bg-slate-900/40 text-slate-200/80";
          }
        });
        updateFormForType(currentType);
      });
    });

    // Recurring checkbox
    const isRecurringInput = document.getElementById("isRecurringInput");
    const recurringFields = document.getElementById("recurringFields");
    
    isRecurringInput.addEventListener("change", () => {
      if (isRecurringInput.checked) {
        recurringFields.classList.remove("hidden");
      } else {
        recurringFields.classList.add("hidden");
      }
    });

    const amountInput = document.getElementById("amountInput");
    const categoryInput = document.getElementById("categoryInput");
    const accountInput = document.getElementById("accountInput");
    const dateInput = document.getElementById("dateInput");
    const transferDateInput = document.getElementById("transferDateInput");
    const noteInput = document.getElementById("noteInput");
    const fromAccountInput = document.getElementById("fromAccountInput");
    const toAccountInput = document.getElementById("toAccountInput");
    const dueDayInput = document.getElementById("dueDayInput");
    const recurringTypeInput = document.getElementById("recurringTypeInput");

    const today = new Date();
    dateInput.valueAsDate = today;
    transferDateInput.valueAsDate = today;

    entryForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const amount = parseFloat(amountInput.value || "0");
      if (!amount || amount <= 0) return;

      let tx;
      
      if (currentType === "transfer") {
        const fromAcc = fromAccountInput.value;
        const toAcc = toAccountInput.value;
        
        if (fromAcc === toAcc) {
          alert("Source and destination accounts must be different!");
          return;
        }
        
        tx = {
          id: crypto.randomUUID(),
          type: "transfer",
          amount,
          category: "Transfer",
          fromAccount: fromAcc,
          toAccount: toAcc,
          account: fromAcc,
          date: transferDateInput.value || new Date().toISOString().slice(0, 10),
          note: noteInput.value.trim(),
          isRecurring: isRecurringInput.checked,
          createdAt: new Date().toISOString(),
        };
        
        if (isRecurringInput.checked) {
          tx.recurringType = recurringTypeInput.value;
          tx.dueDay = parseInt(dueDayInput.value) || 1;
        }
      } else {
        tx = {
          id: crypto.randomUUID(),
          type: currentType,
          amount,
          category: categoryInput.value,
          account: accountInput.value,
          date: dateInput.value || new Date().toISOString().slice(0, 10),
          note: noteInput.value.trim(),
          isRecurring: isRecurringInput.checked,
          createdAt: new Date().toISOString(),
        };
        
        if (isRecurringInput.checked) {
          tx.recurringType = recurringTypeInput.value;
          tx.dueDay = parseInt(dueDayInput.value) || 1;
        }
      }

      state.transactions.unshift(tx);
      recalcAccounts();
      saveState();
      renderAll();

      entryForm.reset();
      currentType = "expense";
      typeToggles[0].click();
      dateInput.valueAsDate = new Date();
      transferDateInput.valueAsDate = new Date();
      recurringFields.classList.add("hidden");

      showScreen("home");
    });

    function recalcAccounts() {
      const accountNames = Object.keys(state.accounts);
      accountNames.forEach(name => {
        state.accounts[name] = state.accountInitialBalances[name] || 0;
      });
      
      // Sort transactions by date for proper calculation
      const sortedTx = [...state.transactions].sort((a, b) => new Date(a.date) - new Date(b.date));
      
      sortedTx.forEach((tx) => {
        if (tx.type === "transfer") {
          // Handle transfer FROM account
          if (state.accounts.hasOwnProperty(tx.fromAccount)) {
            const fromType = state.accountTypes[tx.fromAccount];
            if (fromType === "credit") {
              // Transferring FROM credit card increases outstanding (like a cash advance)
              state.accounts[tx.fromAccount] += tx.amount;
            } else {
              // Normal account: balance decreases
              state.accounts[tx.fromAccount] -= tx.amount;
            }
          }
          
          // Handle transfer TO account
          if (state.accounts.hasOwnProperty(tx.toAccount)) {
            const toType = state.accountTypes[tx.toAccount];
            if (toType === "credit") {
              // Transferring TO credit card reduces outstanding (payment)
              state.accounts[tx.toAccount] -= tx.amount;
            } else {
              // Normal account: balance increases
              state.accounts[tx.toAccount] += tx.amount;
            }
          }
        } else {
          // Income or Expense
          if (state.accounts.hasOwnProperty(tx.account)) {
            const accType = state.accountTypes[tx.account];
            
            if (accType === "credit") {
              // For credit cards:
              // - Expense INCREASES outstanding (spending on credit adds to debt)
              // - Income DECREASES outstanding (cashback/refund credited to card)
              if (tx.type === "expense") {
                state.accounts[tx.account] += tx.amount; // Increase outstanding
              } else if (tx.type === "income") {
                state.accounts[tx.account] -= tx.amount; // Decrease outstanding
              }
            } else {
              // For regular accounts:
              // - Income increases balance
              // - Expense decreases balance
              const sign = tx.type === "income" ? 1 : -1;
              state.accounts[tx.account] += sign * tx.amount;
            }
          }
        }
      });
    }

    function getMonthCycleDates() {
      const now = new Date();
      const startDay = state.monthStartDate || 1;
      let startDate, endDate;
      
      if (now.getDate() >= startDay) {
        startDate = new Date(now.getFullYear(), now.getMonth(), startDay);
        endDate = new Date(now.getFullYear(), now.getMonth() + 1, startDay - 1);
      } else {
        startDate = new Date(now.getFullYear(), now.getMonth() - 1, startDay);
        endDate = new Date(now.getFullYear(), now.getMonth(), startDay - 1);
      }
      
      return { startDate, endDate };
    }

    function formatDateShort(date) {
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    function isInCurrentCycle(txDate) {
      const { startDate, endDate } = getMonthCycleDates();
      const d = new Date(txDate);
      return d >= startDate && d <= endDate;
    }

    function getCurrentMonthKey() {
      const now = new Date();
      return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
    }

    function isDueSoon(dueDay) {
      const now = new Date();
      const currentDay = now.getDate();
      const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
      
      let daysUntilDue;
      if (dueDay >= currentDay) {
        daysUntilDue = dueDay - currentDay;
      } else {
        daysUntilDue = (daysInMonth - currentDay) + dueDay;
      }
      
      return daysUntilDue <= 7 && daysUntilDue >= 0;
    }

    function isReminderPaidThisMonth(reminderId) {
      const monthKey = getCurrentMonthKey();
      return state.reminderPayments[reminderId] && state.reminderPayments[reminderId][monthKey];
    }

    function markReminderPaid(reminderId) {
      const monthKey = getCurrentMonthKey();
      if (!state.reminderPayments[reminderId]) {
        state.reminderPayments[reminderId] = {};
      }
      state.reminderPayments[reminderId][monthKey] = true;
      saveState();
    }

    function isCreditCardSettled(accountName) {
      const balance = state.accounts[accountName] || 0;
      return balance <= 0;
    }

    function payReminder(reminder) {
      const tx = {
        id: crypto.randomUUID(),
        type: reminder.type,
        amount: reminder.amount,
        category: reminder.category,
        account: reminder.account,
        date: new Date().toISOString().slice(0, 10),
        note: `Payment for ${reminder.category} reminder`,
        isRecurring: false,
        paidFromReminder: reminder.id,
        createdAt: new Date().toISOString(),
      };
      
      state.transactions.unshift(tx);
      markReminderPaid(reminder.id);
      recalcAccounts();
      saveState();
      renderAll();
    }

    // Rendering helpers
    const netWorthDisplay = document.getElementById("netWorthDisplay");
    const monthlyIncomeDisplay = document.getElementById("monthlyIncomeDisplay");
    const monthlySpentDisplay = document.getElementById("monthlySpentDisplay");
    const burnRateBar = document.getElementById("burnRateBar");
    const burnRateLabel = document.getElementById("burnRateLabel");
    const transactionCountLabel = document.getElementById("transactionCountLabel");
    const recentList = document.getElementById("recentList");
    const emptyRecent = document.getElementById("emptyRecent");
    const dateCycleLabel = document.getElementById("dateCycleLabel");
    const homeAlertsSection = document.getElementById("homeAlertsSection");

    const logsList = document.getElementById("logsList");
    const emptyLogs = document.getElementById("emptyLogs");
    const logsFilterType = document.getElementById("logsFilterType");
    const logsFilterRange = document.getElementById("logsFilterRange");

    const budgetPlanned = document.getElementById("budgetPlanned");
    const budgetRemaining = document.getElementById("budgetRemaining");
    const budgetBar = document.getElementById("budgetBar");
    const budgetLabel = document.getElementById("budgetLabel");

    const recurringList = document.getElementById("recurringList");
    const emptyRecurring = document.getElementById("emptyRecurring");

    function isSameMonth(d1, d2) {
      return d1.getFullYear() === d2.getFullYear() && d1.getMonth() === d2.getMonth();
    }

    function isSameWeek(d1, d2) {
      const oneDay = 86400000;
      const diff = Math.abs(d1 - d2) / oneDay;
      return diff <= 7;
    }

    function renderHomeAlerts() {
      homeAlertsSection.innerHTML = "";
      
      // Recurring reminders alerts
      const recurringTx = state.transactions.filter(tx => tx.isRecurring && tx.dueDay);
      
      recurringTx.forEach(reminder => {
        if (isDueSoon(reminder.dueDay) && !isReminderPaidThisMonth(reminder.id)) {
          const alert = document.createElement("div");
          
          // Different styling for income vs expense reminders
          const isIncome = reminder.type === "income";
          alert.className = isIncome 
            ? "glass-soft rounded-2xl p-3 flex items-center justify-between border border-emerald-400/30"
            : "glass-soft rounded-2xl p-3 flex items-center justify-between border border-amber-400/30";
          
          const left = document.createElement("div");
          left.className = "flex flex-col";
          
          // Use note as title if available, otherwise use category
          const reminderName = reminder.note && reminder.note.trim() ? reminder.note.trim() : reminder.category;
          
          const title = document.createElement("span");
          title.className = isIncome ? "text-sm font-medium text-emerald-200" : "text-sm font-medium text-amber-200";
          title.textContent = isIncome ? `‚úì ${reminderName} due soon` : `‚ö†Ô∏è ${reminderName} due soon`;
          
          const subtitle = document.createElement("span");
          subtitle.className = "text-[11px] text-slate-400";
          subtitle.textContent = `${reminder.category} ‚Ä¢ Due on ${reminder.dueDay}${getOrdinalSuffix(reminder.dueDay)} ‚Ä¢ ${currency(reminder.amount)}`;
          
          left.appendChild(title);
          left.appendChild(subtitle);
          
          const payBtn = document.createElement("button");
          payBtn.className = "px-3 py-1.5 rounded-full text-xs font-medium bg-gradient-to-r from-emerald-400 to-emerald-500 text-slate-950 shadow-md";
          payBtn.textContent = "Add Entry";
          payBtn.onclick = () => payReminder(reminder);
          
          alert.appendChild(left);
          alert.appendChild(payBtn);
          homeAlertsSection.appendChild(alert);
        }
      });

      // Credit card due date alerts
      for (const accName in state.accountDueDays) {
        const dueDay = state.accountDueDays[accName];
        const type = state.accountTypes[accName];
        const balance = state.accounts[accName] || 0;
        
        if (type === "credit" && dueDay && balance > 0 && isDueSoon(dueDay)) {
          const alert = document.createElement("div");
          alert.className = "glass-soft rounded-2xl p-3 flex items-center justify-between border border-rose-400/30";
          
          const left = document.createElement("div");
          left.className = "flex flex-col";
          
          const title = document.createElement("span");
          title.className = "text-sm font-medium text-rose-200";
          title.textContent = `üí≥ ${accName} payment due`;
          
          const subtitle = document.createElement("span");
          subtitle.className = "text-[11px] text-slate-400";
          subtitle.textContent = `Due on ${dueDay}${getOrdinalSuffix(dueDay)} ‚Ä¢ Outstanding: ${currency(balance)}`;
          
          left.appendChild(title);
          left.appendChild(subtitle);
          
          alert.appendChild(left);
          homeAlertsSection.appendChild(alert);
        }
      }
    }

    function getOrdinalSuffix(day) {
      if (day > 3 && day < 21) return 'th';
      switch (day % 10) {
        case 1: return 'st';
        case 2: return 'nd';
        case 3: return 'rd';
        default: return 'th';
      }
    }

    function renderHome() {
      renderHomeAlerts();
      
      const now = new Date();
      let monthlyIncome = 0;
      let monthlySpent = 0;

      const { startDate, endDate } = getMonthCycleDates();
      dateCycleLabel.textContent = `${formatDateShort(startDate)} - ${formatDateShort(endDate)}`;

      state.transactions.forEach((tx) => {
        if (!isInCurrentCycle(tx.date)) return;
        if (tx.type === "income") monthlyIncome += tx.amount;
        else if (tx.type === "expense") monthlySpent += tx.amount;
      });

      monthlyIncomeDisplay.textContent = currency(monthlyIncome);
      monthlySpentDisplay.textContent = currency(monthlySpent);

      // Calculate net worth (credit cards count as negative)
      let netWorth = 0;
      for (const acc in state.accounts) {
        const type = state.accountTypes[acc];
        const balance = state.accounts[acc];
        if (type === "credit") {
          netWorth -= balance; // Outstanding is a liability
        } else {
          netWorth += balance;
        }
      }
      netWorthDisplay.textContent = currency(netWorth);

      const burnRatio = state.budgetMonthly ? Math.min(1, monthlySpent / state.budgetMonthly) : 0;
      burnRateBar.style.width = `${Math.max(3, burnRatio * 100)}%`;
      burnRateBar.style.backgroundImage = burnRatio < 0.5
        ? "linear-gradient(to right, #4ade80, #22d3ee)"
        : burnRatio < 0.9
        ? "linear-gradient(to right, #22d3ee, #facc15)"
        : "linear-gradient(to right, #fb7185, #f97316)";

      let burnText = "Healthy burn rate";
      if (burnRatio > 0.9) burnText = "You're about to hit your budget";
      else if (burnRatio > 0.6) burnText = "Keep an eye on your spending";
      burnRateLabel.firstElementChild.textContent = burnText;

      const monthlyTx = state.transactions.filter((tx) => isInCurrentCycle(tx.date));
      const count = monthlyTx.length;
      transactionCountLabel.textContent = `${count} transaction${count === 1 ? "" : "s"} this cycle`;

      recentList.innerHTML = "";
      // Sort by date descending
      const sortedTx = [...state.transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
      const recent = sortedTx.slice(0, 5);
      if (recent.length === 0) {
        emptyRecent.classList.remove("hidden");
      } else {
        emptyRecent.classList.add("hidden");
        recent.forEach((tx) => {
          const row = createTransactionRow(tx, true);
          recentList.appendChild(row);
        });
      }
      
      applyMasking();
    }

    function createTransactionRow(tx, showActions = false) {
      const row = document.createElement("div");
      row.className = "glass-soft rounded-2xl px-3 py-2 flex items-center justify-between text-sm";

      const left = document.createElement("div");
      left.className = "flex flex-col flex-1 min-w-0";
      
      // Use note as title if available, otherwise use category
      const displayTitle = tx.note && tx.note.trim() ? tx.note.trim() : tx.category;
      
      const title = document.createElement("span");
      title.className = "text-sm font-medium truncate";
      title.textContent = displayTitle;
      
      const subtitle = document.createElement("span");
      subtitle.className = "text-[11px] text-slate-400";
      const d = new Date(tx.date);
      
      let accountText = tx.account;
      if (tx.type === "transfer") {
        accountText = `${tx.fromAccount} ‚Üí ${tx.toAccount}`;
      }
      
      // Show category in subtitle if note is used as title
      let subtitleText = `${d.toLocaleDateString(undefined, { month: "short", day: "numeric" })}`;
      if (tx.note && tx.note.trim()) {
        subtitleText += ` ‚Ä¢ ${tx.category}`;
      }
      subtitleText += ` ‚Ä¢ ${accountText}`;
      subtitle.textContent = subtitleText;
      
      left.appendChild(title);
      left.appendChild(subtitle);

      const right = document.createElement("div");
      right.className = "flex items-center gap-2";
      
      const amtContainer = document.createElement("div");
      amtContainer.className = "text-right flex flex-col items-end";
      const amt = document.createElement("span");
      amt.className = "amount-display";
      
      if (tx.type === "transfer") {
        amt.textContent = currency(tx.amount);
        amt.className += " text-sky-300";
      } else {
        amt.textContent = (tx.type === "expense" ? "-" : "+") + currency(tx.amount);
        amt.className += tx.type === "expense" ? " text-rose-300" : " text-emerald-300";
      }
      
      amtContainer.appendChild(amt);
      
      right.appendChild(amtContainer);
      
      if (showActions) {
        const actionsDiv = document.createElement("div");
        actionsDiv.className = "flex gap-1 ml-2";
        
        const editBtn = document.createElement("button");
        editBtn.className = "p-1.5 rounded-full hover:bg-slate-700/50 text-slate-400 hover:text-sky-300 transition-colors";
        editBtn.innerHTML = "‚úèÔ∏è";
        editBtn.title = "Edit";
        editBtn.onclick = (e) => {
          e.stopPropagation();
          openEditTransactionModal(tx);
        };
        
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "p-1.5 rounded-full hover:bg-slate-700/50 text-slate-400 hover:text-rose-300 transition-colors";
        deleteBtn.innerHTML = "üóëÔ∏è";
        deleteBtn.title = "Delete";
        deleteBtn.onclick = (e) => {
          e.stopPropagation();
          openDeleteModal(tx.id, "transaction");
        };
        
        actionsDiv.appendChild(editBtn);
        actionsDiv.appendChild(deleteBtn);
        right.appendChild(actionsDiv);
      }

      row.appendChild(left);
      row.appendChild(right);
      return row;
    }

    function renderLogs() {
      logsList.innerHTML = "";
      const type = logsFilterType.value;
      const range = logsFilterRange.value;
      const now = new Date();

      let filtered = state.transactions.filter((tx) => {
        if (type !== "all" && tx.type !== type) return false;
        const d = new Date(tx.date);
        if (range === "month" && !isInCurrentCycle(tx.date)) return false;
        if (range === "week" && !isSameWeek(d, now)) return false;
        return true;
      });

      // Sort by date descending
      filtered = filtered.sort((a, b) => new Date(b.date) - new Date(a.date));

      if (filtered.length === 0) {
        emptyLogs.classList.remove("hidden");
        return;
      }
      emptyLogs.classList.add("hidden");

      filtered.forEach((tx) => {
        const row = createTransactionRow(tx, true);
        logsList.appendChild(row);
      });
      
      applyMasking();
    }

    logsFilterType.addEventListener("change", renderLogs);
    logsFilterRange.addEventListener("change", renderLogs);

    function renderBudget() {
      let monthlySpent = 0;
      const categorySpending = {};
      
      state.transactions.forEach((tx) => {
        if (!isInCurrentCycle(tx.date)) return;
        if (tx.type === "expense") {
          monthlySpent += tx.amount;
          if (!categorySpending[tx.category]) {
            categorySpending[tx.category] = 0;
          }
          categorySpending[tx.category] += tx.amount;
        }
      });

      budgetPlanned.textContent = currency(state.budgetMonthly);
      const remaining = Math.max(0, state.budgetMonthly - monthlySpent);
      budgetRemaining.textContent = currency(remaining);
      budgetRemaining.classList.toggle("text-emerald-300", remaining >= 0);
      budgetRemaining.classList.toggle("text-rose-300", remaining < 0);

      const ratio = state.budgetMonthly ? Math.min(1.2, monthlySpent / state.budgetMonthly) : 0;
      budgetBar.style.width = `${Math.max(2, Math.min(100, ratio * 100))}%`;

      let label = "0% of your budget used this month.";
      if (state.budgetMonthly > 0) {
        const pct = Math.min(120, Math.round((monthlySpent / state.budgetMonthly) * 100));
        label = `${pct}% of your budget used this month.`;
        if (pct > 100) label += " You've gone over budget.";
      }
      budgetLabel.textContent = label;

      // Render category-wise spending
      const categorySpendingList = document.getElementById("categorySpendingList");
      const emptyCategorySpending = document.getElementById("emptyCategorySpending");
      categorySpendingList.innerHTML = "";
      
      const sortedCategories = Object.entries(categorySpending).sort((a, b) => b[1] - a[1]);
      
      if (sortedCategories.length === 0) {
        emptyCategorySpending.classList.remove("hidden");
      } else {
        emptyCategorySpending.classList.add("hidden");
        
        sortedCategories.forEach(([category, amount]) => {
          const budget = state.categories[category]?.budget || 0;
          const card = document.createElement("div");
          card.className = "glass-soft rounded-2xl p-3";
          
          const header = document.createElement("div");
          header.className = "flex items-center justify-between mb-2";
          
          const catName = document.createElement("span");
          catName.className = "text-sm font-medium";
          catName.textContent = category;
          
          const amountSpan = document.createElement("span");
          amountSpan.className = "text-sm font-semibold amount-display";
          if (budget > 0 && amount > budget) {
            amountSpan.className += " text-rose-300";
          } else {
            amountSpan.className += " text-slate-100";
          }
          amountSpan.textContent = currency(amount);
          
          header.appendChild(catName);
          header.appendChild(amountSpan);
          card.appendChild(header);
          
          if (budget > 0) {
            const progressContainer = document.createElement("div");
            progressContainer.className = "h-1.5 rounded-full bg-slate-800/80 overflow-hidden mb-1";
            
            const progressBar = document.createElement("div");
            const pct = Math.min(100, (amount / budget) * 100);
            progressBar.className = "h-full rounded-full transition-all duration-500";
            progressBar.style.width = `${pct}%`;
            
            if (pct > 100) {
              progressBar.style.background = "linear-gradient(to right, #fb7185, #f97316)";
            } else if (pct > 75) {
              progressBar.style.background = "linear-gradient(to right, #facc15, #f97316)";
            } else {
              progressBar.style.background = "linear-gradient(to right, #4ade80, #22d3ee)";
            }
            
            progressContainer.appendChild(progressBar);
            card.appendChild(progressContainer);
            
            const budgetInfo = document.createElement("p");
            budgetInfo.className = "text-[11px] text-slate-400";
            budgetInfo.textContent = `${Math.round(pct)}% of ${currency(budget)} budget`;
            card.appendChild(budgetInfo);
          }
          
          categorySpendingList.appendChild(card);
        });
      }
      
      applyMasking();
    }

    function renderAccounts() {
      const accountsList = document.getElementById("accountsList");
      const emptyAccounts = document.getElementById("emptyAccounts");
      accountsList.innerHTML = "";
      
      const accountNames = Object.keys(state.accounts);
      
      if (accountNames.length === 0) {
        emptyAccounts.classList.remove("hidden");
        return;
      }
      
      emptyAccounts.classList.add("hidden");
      
      const typeIcons = {
        bank: "üè¶",
        wallet: "üíµ",
        credit: "üí≥",
        investment: "üìà",
        other: "üìÅ"
      };
      
      const monthKey = getCurrentMonthKey();
      
      accountNames.forEach(name => {
        const balance = state.accounts[name];
        const type = (state.accountTypes && state.accountTypes[name]) || "other";
        const icon = typeIcons[type] || "üìÅ";
        const isCredit = type === "credit";
        const isSettled = isCredit && balance <= 0;
        
        const card = document.createElement("div");
        card.className = "glass-soft rounded-2xl p-4 flex items-center justify-between";
        
        const left = document.createElement("div");
        left.className = "flex items-center gap-3";
        
        const iconSpan = document.createElement("span");
        iconSpan.className = "text-2xl";
        iconSpan.textContent = icon;
        
        const info = document.createElement("div");
        info.className = "flex flex-col";
        
        const nameSpan = document.createElement("span");
        nameSpan.className = "text-sm font-medium";
        nameSpan.textContent = name;
        
        const typeSpan = document.createElement("span");
        typeSpan.className = "text-[11px] text-slate-400 capitalize";
        typeSpan.textContent = type.replace('_', ' ');
        
        info.appendChild(nameSpan);
        info.appendChild(typeSpan);
        left.appendChild(iconSpan);
        left.appendChild(info);
        
        const right = document.createElement("div");
        right.className = "flex items-center gap-2";
        
        const balanceContainer = document.createElement("div");
        balanceContainer.className = "text-right flex flex-col items-end";
        
        if (isCredit) {
          if (isSettled) {
            const settledBadge = document.createElement("span");
            settledBadge.className = "text-[10px] px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-300 border border-emerald-400/40 mb-1";
            settledBadge.textContent = "Settled ‚úì";
            balanceContainer.appendChild(settledBadge);
            
            const balanceSpan = document.createElement("span");
            balanceSpan.className = "text-lg font-semibold text-emerald-300 amount-display";
            balanceSpan.textContent = currency(0);
            balanceContainer.appendChild(balanceSpan);
          } else {
            const labelSpan = document.createElement("span");
            labelSpan.className = "text-[10px] text-rose-400 uppercase tracking-wider";
            labelSpan.textContent = "Outstanding";
            balanceContainer.appendChild(labelSpan);
            
            const balanceSpan = document.createElement("span");
            balanceSpan.className = "text-lg font-semibold text-rose-400 amount-display";
            balanceSpan.textContent = currency(balance);
            balanceContainer.appendChild(balanceSpan);
          }
        } else {
          const balanceSpan = document.createElement("span");
          balanceSpan.className = `text-lg font-semibold amount-display ${balance >= 0 ? 'text-emerald-300' : 'text-rose-300'}`;
          balanceSpan.textContent = currency(Math.abs(balance));
          if (balance < 0) {
            balanceSpan.textContent = '-' + balanceSpan.textContent;
          }
          balanceContainer.appendChild(balanceSpan);
        }
        
        right.appendChild(balanceContainer);
        
        // Edit and Delete buttons
        const actionsDiv = document.createElement("div");
        actionsDiv.className = "flex gap-1 ml-2";
        
        const editBtn = document.createElement("button");
        editBtn.className = "p-1.5 rounded-full hover:bg-slate-700/50 text-slate-400 hover:text-sky-300 transition-colors";
        editBtn.innerHTML = "‚úèÔ∏è";
        editBtn.title = "Edit";
        editBtn.onclick = (e) => {
          e.stopPropagation();
          openEditAccountModal(name);
        };
        
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "p-1.5 rounded-full hover:bg-slate-700/50 text-slate-400 hover:text-rose-300 transition-colors";
        deleteBtn.innerHTML = "üóëÔ∏è";
        deleteBtn.title = "Delete";
        deleteBtn.onclick = (e) => {
          e.stopPropagation();
          openDeleteModal(name, "account");
        };
        
        actionsDiv.appendChild(editBtn);
        actionsDiv.appendChild(deleteBtn);
        right.appendChild(actionsDiv);
        
        card.appendChild(left);
        card.appendChild(right);
        accountsList.appendChild(card);
      });
      
      updateAccountDropdowns();
      applyMasking();
    }

    function updateAccountDropdowns() {
      const accountNames = Object.keys(state.accounts);
      const dropdowns = [
        document.getElementById("accountInput"),
        document.getElementById("fromAccountInput"),
        document.getElementById("toAccountInput"),
        document.getElementById("editTxAccount"),
        document.getElementById("editTxFromAccount"),
        document.getElementById("editTxToAccount")
      ];
      
      dropdowns.forEach(dropdown => {
        if (!dropdown) return;
        dropdown.innerHTML = "";
        accountNames.forEach(name => {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          dropdown.appendChild(opt);
        });
      });
    }

    function renderRecurring() {
      recurringList.innerHTML = "";
      const recurring = state.transactions.filter((tx) => tx.isRecurring);
      
      if (recurring.length === 0) {
        emptyRecurring.classList.remove("hidden");
        return;
      }
      emptyRecurring.classList.add("hidden");

      recurring.forEach((tx) => {
        const isPaid = isReminderPaidThisMonth(tx.id);
        
        const row = document.createElement("div");
        row.className = "glass-soft rounded-2xl px-3 py-2 flex items-center justify-between";

        const left = document.createElement("div");
        left.className = "flex flex-col flex-1";
        
        // Use note as title if available, otherwise use category
        const reminderName = tx.note && tx.note.trim() ? tx.note.trim() : tx.category;
        
        const title = document.createElement("span");
        title.className = "text-sm font-medium";
        title.textContent = reminderName;
        
        const subtitle = document.createElement("span");
        subtitle.className = "text-[11px] text-slate-400";
        
        let typeLabel = tx.type === "expense" ? "Bill" : tx.type === "income" ? "Income" : "Transfer";
        let accountText = tx.type === "transfer" ? `${tx.fromAccount} ‚Üí ${tx.toAccount}` : tx.account;
        let subtitleText = `${tx.category} ‚Ä¢ ${typeLabel} ‚Ä¢ ${accountText}`;
        if (tx.dueDay) {
          subtitleText += ` ‚Ä¢ Due: ${tx.dueDay}${getOrdinalSuffix(tx.dueDay)}`;
        }
        subtitle.textContent = subtitleText;
        left.appendChild(title);
        left.appendChild(subtitle);

        const middle = document.createElement("div");
        middle.className = "flex flex-col items-center mx-2";
        
        const statusBadge = document.createElement("span");
        if (isPaid) {
          statusBadge.className = "text-[10px] px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-300 border border-emerald-400/40";
          statusBadge.textContent = "Paid ‚úì";
        } else {
          statusBadge.className = "text-[10px] px-2 py-0.5 rounded-full bg-amber-500/20 text-amber-300 border border-amber-400/40";
          statusBadge.textContent = "Pending";
        }
        middle.appendChild(statusBadge);

        const right = document.createElement("div");
        right.className = "flex items-center gap-2";
        
        const amtDiv = document.createElement("div");
        amtDiv.className = "text-right text-sm amount-display";
        if (tx.type === "transfer") {
          amtDiv.textContent = currency(tx.amount);
          amtDiv.className += " text-sky-300";
        } else {
          amtDiv.textContent = (tx.type === "expense" ? "-" : "+") + currency(tx.amount);
          amtDiv.className += tx.type === "expense" ? " text-rose-300" : " text-emerald-300";
        }
        
        const actionsDiv = document.createElement("div");
        actionsDiv.className = "flex gap-1 ml-2";
        
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "p-1.5 rounded-full hover:bg-slate-700/50 text-slate-400 hover:text-rose-300 transition-colors";
        deleteBtn.innerHTML = "üóëÔ∏è";
        deleteBtn.title = "Delete Reminder";
        deleteBtn.onclick = (e) => {
          e.stopPropagation();
          openDeleteModal(tx.id, "reminder");
        };
        
        actionsDiv.appendChild(deleteBtn);
        right.appendChild(amtDiv);
        right.appendChild(actionsDiv);

        row.appendChild(left);
        row.appendChild(middle);
        row.appendChild(right);
        recurringList.appendChild(row);
      });
      
      applyMasking();
    }

    function renderCategoryBudgets() {
      const container = document.getElementById("categoryBudgetsList");
      container.innerHTML = "";
      
      const categories = state.categories;
      
      for (const catName in categories) {
        const cat = categories[catName];
        if (cat.type === "neutral") continue;
        
        const row = document.createElement("div");
        row.className = "flex items-center justify-between gap-3 py-2 border-b border-slate-700/50 last:border-0";
        
        const left = document.createElement("div");
        left.className = "flex-1 min-w-0";
        
        const nameSpan = document.createElement("span");
        nameSpan.className = "text-xs font-medium truncate block";
        nameSpan.textContent = catName;
        
        const typeSpan = document.createElement("span");
        typeSpan.className = `text-[10px] ${cat.type === 'income' ? 'text-emerald-400' : 'text-rose-400'}`;
        typeSpan.textContent = cat.type;
        
        left.appendChild(nameSpan);
        left.appendChild(typeSpan);
        
        const right = document.createElement("div");
        right.className = "flex items-center gap-1";
        
        const currencySpan = document.createElement("span");
        currencySpan.className = "text-slate-500 text-xs";
        currencySpan.textContent = "‚Çπ";
        
        const input = document.createElement("input");
        input.type = "number";
        input.inputMode = "decimal";
        input.step = "100";
        input.min = "0";
        input.value = cat.budget || 0;
        input.className = "w-20 rounded-xl bg-slate-950/70 border border-slate-700/80 px-2 py-1 text-xs outline-none text-right";
        input.dataset.category = catName;
        
        input.addEventListener("change", (e) => {
          const value = parseFloat(e.target.value) || 0;
          state.categories[catName].budget = value;
          saveState();
          renderBudget();
        });
        
        right.appendChild(currencySpan);
        right.appendChild(input);
        
        row.appendChild(left);
        row.appendChild(right);
        container.appendChild(row);
      }
    }

    function getMonthCycleKey(date) {
      const d = new Date(date);
      const startDay = state.monthStartDate || 1;
      let cycleYear = d.getFullYear();
      let cycleMonth = d.getMonth();
      
      if (d.getDate() < startDay) {
        cycleMonth--;
        if (cycleMonth < 0) {
          cycleMonth = 11;
          cycleYear--;
        }
      }
      
      const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
      return `${monthNames[cycleMonth]} ${cycleYear}`;
    }

    function getMonthCycleDatesForKey(cycleKey) {
      const parts = cycleKey.split(" ");
      const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
      const month = monthNames.indexOf(parts[0]);
      const year = parseInt(parts[1]);
      const startDay = state.monthStartDate || 1;
      
      const startDate = new Date(year, month, startDay);
      const endDate = new Date(year, month + 1, startDay - 1);
      
      return { startDate, endDate };
    }

    function isInCycle(txDate, startDate, endDate) {
      const d = new Date(txDate);
      return d >= startDate && d <= endDate;
    }

    function downloadMonthArchive(cycleKey) {
      const { startDate, endDate } = getMonthCycleDatesForKey(cycleKey);
      const cycleTransactions = state.transactions.filter(tx => isInCycle(tx.date, startDate, endDate));
      
      const lines = [];
      lines.push(`TRANSACTION ARCHIVE - ${cycleKey}`);
      lines.push(`Cycle: ${formatDateShort(startDate)} - ${formatDateShort(endDate)}`);
      lines.push("");
      lines.push("Date,Type,Category,Amount,Account,Note");
      
      const sortedTx = cycleTransactions.slice().sort((a, b) => new Date(b.date) - new Date(a.date));
      
      for (let i = 0; i < sortedTx.length; i++) {
        const tx = sortedTx[i];
        const account = tx.type === "transfer" ? (tx.fromAccount + " to " + tx.toAccount) : (tx.account || "");
        const note = (tx.note || "").replace(/,/g, " ");
        const row = [
          tx.date || "",
          tx.type || "",
          tx.category || "",
          tx.amount || 0,
          account,
          note
        ];
        lines.push(row.join(","));
      }
      
      lines.push("");
      lines.push("SUMMARY");
      
      let totalIncome = 0;
      let totalExpense = 0;
      
      cycleTransactions.forEach(tx => {
        if (tx.type === "income") totalIncome += tx.amount;
        else if (tx.type === "expense") totalExpense += tx.amount;
      });
      
      lines.push(`Total Income,${totalIncome}`);
      lines.push(`Total Expenses,${totalExpense}`);
      lines.push(`Net,${totalIncome - totalExpense}`);
      lines.push(`Total Transactions,${cycleTransactions.length}`);
      
      const csvContent = lines.join("\n");
      const fileName = `fintrack_archive_${cycleKey.replace(" ", "_")}.csv`;
      
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      
      if (navigator.msSaveBlob) {
        navigator.msSaveBlob(blob, fileName);
        return;
      }
      
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.style.display = "none";
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      
      setTimeout(() => {
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
      }, 100);
    }

    function renderArchive() {
      const archiveList = document.getElementById("archiveList");
      const emptyArchive = document.getElementById("emptyArchive");
      archiveList.innerHTML = "";
      
      const monthCycles = {};
      
      state.transactions.forEach(tx => {
        const cycleKey = getMonthCycleKey(tx.date);
        if (!monthCycles[cycleKey]) {
          monthCycles[cycleKey] = [];
        }
        monthCycles[cycleKey].push(tx);
      });
      
      const sortedCycles = Object.keys(monthCycles).sort((a, b) => {
        const dateA = getMonthCycleDatesForKey(a).startDate;
        const dateB = getMonthCycleDatesForKey(b).startDate;
        return dateB - dateA;
      });
      
      if (sortedCycles.length === 0) {
        emptyArchive.classList.remove("hidden");
        return;
      }
      
      emptyArchive.classList.add("hidden");
      
      sortedCycles.forEach(cycleKey => {
        const transactions = monthCycles[cycleKey];
        const { startDate, endDate } = getMonthCycleDatesForKey(cycleKey);
        
        let totalIncome = 0;
        let totalExpense = 0;
        
        transactions.forEach(tx => {
          if (tx.type === "income") totalIncome += tx.amount;
          else if (tx.type === "expense") totalExpense += tx.amount;
        });
        
        const row = document.createElement("div");
        row.className = "flex items-center justify-between gap-3 py-2.5 px-3 rounded-2xl bg-slate-950/40 border border-slate-700/50 hover:border-sky-400/40 transition-colors";
        
        const left = document.createElement("div");
        left.className = "flex-1";
        
        const titleDiv = document.createElement("div");
        titleDiv.className = "flex items-center gap-2 mb-1";
        
        const monthSpan = document.createElement("span");
        monthSpan.className = "text-sm font-semibold text-slate-100";
        monthSpan.textContent = cycleKey;
        
        const countBadge = document.createElement("span");
        countBadge.className = "text-[10px] px-2 py-0.5 rounded-full bg-sky-500/20 text-sky-300 border border-sky-400/40";
        countBadge.textContent = `${transactions.length} txn${transactions.length === 1 ? '' : 's'}`;
        
        titleDiv.appendChild(monthSpan);
        titleDiv.appendChild(countBadge);
        
        const dateSpan = document.createElement("div");
        dateSpan.className = "text-[10px] text-slate-400";
        dateSpan.textContent = `${formatDateShort(startDate)} - ${formatDateShort(endDate)}`;
        
        const statsDiv = document.createElement("div");
        statsDiv.className = "flex gap-3 mt-1.5 text-[10px]";
        
        const incomeSpan = document.createElement("span");
        incomeSpan.className = "text-emerald-400";
        incomeSpan.textContent = `‚Üë ${currency(totalIncome)}`;
        
        const expenseSpan = document.createElement("span");
        expenseSpan.className = "text-rose-400";
        expenseSpan.textContent = `‚Üì ${currency(totalExpense)}`;
        
        statsDiv.appendChild(incomeSpan);
        statsDiv.appendChild(expenseSpan);
        
        left.appendChild(titleDiv);
        left.appendChild(dateSpan);
        left.appendChild(statsDiv);
        
        const downloadBtn = document.createElement("button");
        downloadBtn.className = "px-3 py-1.5 rounded-full text-xs font-medium bg-gradient-to-r from-sky-400 to-sky-500 text-slate-950 hover:from-sky-500 hover:to-sky-600 transition-all shadow-md";
        downloadBtn.innerHTML = "üì• CSV";
        downloadBtn.onclick = () => downloadMonthArchive(cycleKey);
        
        row.appendChild(left);
        row.appendChild(downloadBtn);
        archiveList.appendChild(row);
      });
    }

    function renderSettings() {
      const monthStartDateInput = document.getElementById("monthStartDateInput");
      monthStartDateInput.value = state.monthStartDate || 1;
      
      monthStartDateInput.addEventListener("change", () => {
        const val = parseInt(monthStartDateInput.value);
        if (val >= 1 && val <= 31) {
          state.monthStartDate = val;
          saveState();
          renderAll();
        }
      });
      
      renderCategoryBudgets();
      renderArchive();
    }

    function renderAll() {
      renderHome();
      renderLogs();
      renderBudget();
      renderAccounts();
      renderRecurring();
      renderSettings();
      updateCategoryDropdown(currentType);
    }

    // Add Account Modal
    const addAccountBtn = document.getElementById("addAccountBtn");
    const addAccountModal = document.getElementById("addAccountModal");
    const addAccountForm = document.getElementById("addAccountForm");
    const cancelAddAccount = document.getElementById("cancelAddAccount");
    const newAccountType = document.getElementById("newAccountType");
    const creditCardDueDateField = document.getElementById("creditCardDueDateField");

    newAccountType.addEventListener("change", () => {
      if (newAccountType.value === "credit") {
        creditCardDueDateField.classList.remove("hidden");
      } else {
        creditCardDueDateField.classList.add("hidden");
      }
    });

    addAccountBtn.addEventListener("click", () => {
      addAccountModal.classList.remove("hidden");
      addAccountModal.classList.add("flex");
      document.getElementById("newAccountName").focus();
    });

    cancelAddAccount.addEventListener("click", () => {
      addAccountModal.classList.add("hidden");
      addAccountModal.classList.remove("flex");
      addAccountForm.reset();
      creditCardDueDateField.classList.add("hidden");
    });

    addAccountModal.addEventListener("click", (e) => {
      if (e.target === addAccountModal) {
        addAccountModal.classList.add("hidden");
        addAccountModal.classList.remove("flex");
        addAccountForm.reset();
        creditCardDueDateField.classList.add("hidden");
      }
    });

    addAccountForm.addEventListener("submit", (e) => {
      e.preventDefault();
      
      const name = document.getElementById("newAccountName").value.trim();
      const balance = parseFloat(document.getElementById("newAccountBalance").value) || 0;
      const type = document.getElementById("newAccountType").value;
      const dueDay = parseInt(document.getElementById("newAccountDueDay").value) || null;
      
      if (!name) return;
      
      if (state.accounts.hasOwnProperty(name)) {
        alert("An account with this name already exists!");
        return;
      }
      
      state.accounts[name] = balance;
      state.accountTypes[name] = type;
      state.accountInitialBalances[name] = balance;
      if (type === "credit" && dueDay) {
        state.accountDueDays[name] = dueDay;
      }
      
      recalcAccounts();
      saveState();
      renderAll();
      
      addAccountModal.classList.add("hidden");
      addAccountModal.classList.remove("flex");
      addAccountForm.reset();
      creditCardDueDateField.classList.add("hidden");
    });

    // Edit Account Modal
    const editAccountModal = document.getElementById("editAccountModal");
    const editAccountForm = document.getElementById("editAccountForm");
    const cancelEditAccount = document.getElementById("cancelEditAccount");
    const editAccountType = document.getElementById("editAccountType");
    const editCreditCardDueDateField = document.getElementById("editCreditCardDueDateField");

    editAccountType.addEventListener("change", () => {
      if (editAccountType.value === "credit") {
        editCreditCardDueDateField.classList.remove("hidden");
      } else {
        editCreditCardDueDateField.classList.add("hidden");
      }
    });

    function openEditAccountModal(accountName) {
      document.getElementById("editAccountOldName").value = accountName;
      document.getElementById("editAccountName").value = accountName;
      document.getElementById("editAccountType").value = state.accountTypes[accountName] || "other";
      document.getElementById("editAccountBalance").value = state.accountInitialBalances[accountName] || 0;
      
      const type = state.accountTypes[accountName];
      if (type === "credit") {
        editCreditCardDueDateField.classList.remove("hidden");
        document.getElementById("editAccountDueDay").value = state.accountDueDays[accountName] || "";
      } else {
        editCreditCardDueDateField.classList.add("hidden");
      }
      
      editAccountModal.classList.remove("hidden");
      editAccountModal.classList.add("flex");
    }

    cancelEditAccount.addEventListener("click", () => {
      editAccountModal.classList.add("hidden");
      editAccountModal.classList.remove("flex");
    });

    editAccountModal.addEventListener("click", (e) => {
      if (e.target === editAccountModal) {
        editAccountModal.classList.add("hidden");
        editAccountModal.classList.remove("flex");
      }
    });

    editAccountForm.addEventListener("submit", (e) => {
      e.preventDefault();
      
      const oldName = document.getElementById("editAccountOldName").value;
      const newName = document.getElementById("editAccountName").value.trim();
      const type = document.getElementById("editAccountType").value;
      const balance = parseFloat(document.getElementById("editAccountBalance").value) || 0;
      const dueDay = parseInt(document.getElementById("editAccountDueDay").value) || null;
      
      if (!newName) return;
      
      if (newName !== oldName && state.accounts.hasOwnProperty(newName)) {
        alert("An account with this name already exists!");
        return;
      }
      
      // Update account name in transactions if changed
      if (newName !== oldName) {
        state.transactions.forEach(tx => {
          if (tx.account === oldName) tx.account = newName;
          if (tx.fromAccount === oldName) tx.fromAccount = newName;
          if (tx.toAccount === oldName) tx.toAccount = newName;
        });
        
        delete state.accounts[oldName];
        delete state.accountTypes[oldName];
        delete state.accountInitialBalances[oldName];
        delete state.accountDueDays[oldName];
      }
      
      state.accounts[newName] = balance;
      state.accountTypes[newName] = type;
      state.accountInitialBalances[newName] = balance;
      if (type === "credit" && dueDay) {
        state.accountDueDays[newName] = dueDay;
      }
      
      recalcAccounts();
      saveState();
      renderAll();
      
      editAccountModal.classList.add("hidden");
      editAccountModal.classList.remove("flex");
    });

    // Edit Transaction Modal
    const editTransactionModal = document.getElementById("editTransactionModal");
    const editTransactionForm = document.getElementById("editTransactionForm");
    const cancelEditTx = document.getElementById("cancelEditTx");
    const editTxType = document.getElementById("editTxType");

    function updateEditTransactionFormForType(type, tx = null) {
      const categoryField = document.getElementById("editTxCategoryField");
      const regularAccountField = document.getElementById("editTxRegularAccountField");
      const transferFields = document.getElementById("editTxTransferFields");
      
      if (type === "transfer") {
        categoryField.classList.add("hidden");
        regularAccountField.classList.add("hidden");
        transferFields.classList.remove("hidden");
        
        // Populate transfer account dropdowns
        updateAccountDropdowns();
        
        if (tx) {
          document.getElementById("editTxFromAccount").value = tx.fromAccount || "";
          document.getElementById("editTxToAccount").value = tx.toAccount || "";
        }
      } else {
        categoryField.classList.remove("hidden");
        regularAccountField.classList.remove("hidden");
        transferFields.classList.add("hidden");
        
        // Update category dropdown
        const editCatSelect = document.getElementById("editTxCategory");
        editCatSelect.innerHTML = "";
        let cats = type === "income" ? incomeCategories : expenseCategories;
        cats.forEach(cat => {
          const opt = document.createElement("option");
          opt.value = cat;
          opt.textContent = cat;
          if (tx && cat === tx.category) opt.selected = true;
          editCatSelect.appendChild(opt);
        });
      }
    }

    function openEditTransactionModal(tx) {
      document.getElementById("editTxId").value = tx.id;
      document.getElementById("editTxType").value = tx.type;
      document.getElementById("editTxAmount").value = tx.amount;
      document.getElementById("editTxDate").value = tx.date;
      document.getElementById("editTxNote").value = tx.note || "";
      
      updateEditTransactionFormForType(tx.type, tx);
      
      // Populate accounts
      updateAccountDropdowns();
      if (tx.type !== "transfer") {
        document.getElementById("editTxAccount").value = tx.account;
      }
      
      // Set recurring fields
      const editTxIsRecurring = document.getElementById("editTxIsRecurring");
      const editTxRecurringFields = document.getElementById("editTxRecurringFields");
      const editTxRecurringContainer = document.getElementById("editTxRecurringContainer");
      
      // Show recurring option for all transaction types now
      editTxRecurringContainer.classList.remove("hidden");
      editTxIsRecurring.checked = tx.isRecurring || false;
      
      if (tx.isRecurring) {
        editTxRecurringFields.classList.remove("hidden");
        document.getElementById("editTxRecurringType").value = tx.recurringType || "monthly";
        document.getElementById("editTxDueDay").value = tx.dueDay || "";
      } else {
        editTxRecurringFields.classList.add("hidden");
      }
      
      editTransactionModal.classList.remove("hidden");
      editTransactionModal.classList.add("flex");
    }

    editTxType.addEventListener("change", (e) => {
      updateEditTransactionFormForType(e.target.value);
      
      // Keep recurring option visible for all types now
      const editTxRecurringContainer = document.getElementById("editTxRecurringContainer");
      editTxRecurringContainer.classList.remove("hidden");
    });
    
    // Edit Transaction Recurring checkbox handler
    document.getElementById("editTxIsRecurring").addEventListener("change", (e) => {
      const editTxRecurringFields = document.getElementById("editTxRecurringFields");
      if (e.target.checked) {
        editTxRecurringFields.classList.remove("hidden");
      } else {
        editTxRecurringFields.classList.add("hidden");
      }
    });

    cancelEditTx.addEventListener("click", () => {
      editTransactionModal.classList.add("hidden");
      editTransactionModal.classList.remove("flex");
    });

    editTransactionModal.addEventListener("click", (e) => {
      if (e.target === editTransactionModal) {
        editTransactionModal.classList.add("hidden");
        editTransactionModal.classList.remove("flex");
      }
    });

    editTransactionForm.addEventListener("submit", (e) => {
      e.preventDefault();
      
      const id = document.getElementById("editTxId").value;
      const txIndex = state.transactions.findIndex(tx => tx.id === id);
      
      if (txIndex === -1) return;
      
      const type = document.getElementById("editTxType").value;
      const isRecurring = document.getElementById("editTxIsRecurring").checked;
      
      if (type === "transfer") {
        const fromAcc = document.getElementById("editTxFromAccount").value;
        const toAcc = document.getElementById("editTxToAccount").value;
        
        if (fromAcc === toAcc) {
          alert("Source and destination accounts must be different!");
          return;
        }
        
        state.transactions[txIndex] = {
          ...state.transactions[txIndex],
          type: "transfer",
          amount: parseFloat(document.getElementById("editTxAmount").value),
          category: "Transfer",
          fromAccount: fromAcc,
          toAccount: toAcc,
          account: fromAcc,
          date: document.getElementById("editTxDate").value,
          note: document.getElementById("editTxNote").value.trim(),
          isRecurring: isRecurring
        };
        
        // Handle recurring fields for transfers
        if (isRecurring) {
          state.transactions[txIndex].recurringType = document.getElementById("editTxRecurringType").value;
          state.transactions[txIndex].dueDay = parseInt(document.getElementById("editTxDueDay").value) || 1;
        } else {
          // Remove recurring properties if not recurring
          delete state.transactions[txIndex].recurringType;
          delete state.transactions[txIndex].dueDay;
          // Also remove from reminder payments if it was previously a reminder
          if (state.reminderPayments[id]) {
            delete state.reminderPayments[id];
          }
        }
      } else {
        state.transactions[txIndex] = {
          ...state.transactions[txIndex],
          type: type,
          amount: parseFloat(document.getElementById("editTxAmount").value),
          category: document.getElementById("editTxCategory").value,
          account: document.getElementById("editTxAccount").value,
          date: document.getElementById("editTxDate").value,
          note: document.getElementById("editTxNote").value.trim(),
          isRecurring: isRecurring
        };
        
        // Handle recurring fields
        if (isRecurring) {
          state.transactions[txIndex].recurringType = document.getElementById("editTxRecurringType").value;
          state.transactions[txIndex].dueDay = parseInt(document.getElementById("editTxDueDay").value) || 1;
        } else {
          // Remove recurring properties if not recurring
          delete state.transactions[txIndex].recurringType;
          delete state.transactions[txIndex].dueDay;
          // Also remove from reminder payments if it was previously a reminder
          if (state.reminderPayments[id]) {
            delete state.reminderPayments[id];
          }
        }
      }
      
      recalcAccounts();
      saveState();
      renderAll();
      
      editTransactionModal.classList.add("hidden");
      editTransactionModal.classList.remove("flex");
    });

    // Edit Budget Modal
    const editBudgetModal = document.getElementById("editBudgetModal");
    const editBudgetForm = document.getElementById("editBudgetForm");
    const cancelEditBudget = document.getElementById("cancelEditBudget");

    document.getElementById("editBudgetBtn").addEventListener("click", () => {
      document.getElementById("budgetAmountInput").value = state.budgetMonthly;
      editBudgetModal.classList.remove("hidden");
      editBudgetModal.classList.add("flex");
    });

    cancelEditBudget.addEventListener("click", () => {
      editBudgetModal.classList.add("hidden");
      editBudgetModal.classList.remove("flex");
    });

    editBudgetModal.addEventListener("click", (e) => {
      if (e.target === editBudgetModal) {
        editBudgetModal.classList.add("hidden");
        editBudgetModal.classList.remove("flex");
      }
    });

    editBudgetForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const amount = parseFloat(document.getElementById("budgetAmountInput").value) || 0;
      state.budgetMonthly = amount;
      saveState();
      renderAll();
      
      editBudgetModal.classList.add("hidden");
      editBudgetModal.classList.remove("flex");
    });

    // Delete Confirmation Modal
    const deleteConfirmModal = document.getElementById("deleteConfirmModal");
    const cancelDelete = document.getElementById("cancelDelete");
    const confirmDelete = document.getElementById("confirmDelete");

    function openDeleteModal(id, type) {
      document.getElementById("deleteItemId").value = id;
      document.getElementById("deleteItemType").value = type;
      deleteConfirmModal.classList.remove("hidden");
      deleteConfirmModal.classList.add("flex");
    }

    cancelDelete.addEventListener("click", () => {
      deleteConfirmModal.classList.add("hidden");
      deleteConfirmModal.classList.remove("flex");
    });

    deleteConfirmModal.addEventListener("click", (e) => {
      if (e.target === deleteConfirmModal) {
        deleteConfirmModal.classList.add("hidden");
        deleteConfirmModal.classList.remove("flex");
      }
    });

    confirmDelete.addEventListener("click", () => {
      const id = document.getElementById("deleteItemId").value;
      const type = document.getElementById("deleteItemType").value;
      
      if (type === "transaction" || type === "reminder") {
        state.transactions = state.transactions.filter(tx => tx.id !== id);
        if (state.reminderPayments[id]) {
          delete state.reminderPayments[id];
        }
      } else if (type === "account") {
        // Check if account has transactions
        const hasTransactions = state.transactions.some(tx => 
          tx.account === id || tx.fromAccount === id || tx.toAccount === id
        );
        
        if (hasTransactions) {
          alert("Cannot delete account with existing transactions. Please delete transactions first.");
          deleteConfirmModal.classList.add("hidden");
          deleteConfirmModal.classList.remove("flex");
          return;
        }
        
        delete state.accounts[id];
        delete state.accountTypes[id];
        delete state.accountInitialBalances[id];
        delete state.accountDueDays[id];
      }
      
      recalcAccounts();
      saveState();
      renderAll();
      
      deleteConfirmModal.classList.add("hidden");
      deleteConfirmModal.classList.remove("flex");
    });

    // Export CSV - Direct download function
    function downloadCSV() {
      var cycleDates = getMonthCycleDates();
      var startDate = cycleDates.startDate;
      var endDate = cycleDates.endDate;
      
      var lines = [];
      
      // Transaction headers
      lines.push("TRANSACTIONS");
      lines.push("Date,Type,Category,Amount,Account,Note");
      
      // Sort transactions by date descending
      var sortedTx = state.transactions.slice().sort(function(a, b) {
        return new Date(b.date) - new Date(a.date);
      });
      
      for (var i = 0; i < sortedTx.length; i++) {
        var tx = sortedTx[i];
        var account = tx.type === "transfer" ? (tx.fromAccount + " to " + tx.toAccount) : (tx.account || "");
        var note = (tx.note || "").replace(/,/g, " ");
        var row = [
          tx.date || "",
          tx.type || "",
          tx.category || "",
          tx.amount || 0,
          account,
          note
        ];
        lines.push(row.join(","));
      }
      
      // Budget summary
      lines.push("");
      lines.push("BUDGET SUMMARY (Current Month Cycle)");
      lines.push("Cycle Start," + formatDateShort(startDate));
      lines.push("Cycle End," + formatDateShort(endDate));
      lines.push("Monthly Budget," + state.budgetMonthly);
      lines.push("");
      lines.push("Category,Amount Spent,Budget,Status");
      
      var categorySpending = {};
      var totalSpent = 0;
      
      for (var j = 0; j < state.transactions.length; j++) {
        var t = state.transactions[j];
        if (!isInCurrentCycle(t.date) || t.type !== "expense") continue;
        if (!categorySpending[t.category]) categorySpending[t.category] = 0;
        categorySpending[t.category] += t.amount;
        totalSpent += t.amount;
      }
      
      for (var cat in state.categories) {
        if (state.categories[cat].type === "neutral") continue;
        var spent = categorySpending[cat] || 0;
        var budget = state.categories[cat].budget || 0;
        var status = budget > 0 ? (spent > budget ? "Over Budget" : "Within Budget") : "No Budget Set";
        lines.push(cat + "," + spent + "," + budget + "," + status);
      }
      
      lines.push("");
      lines.push("Total Spent," + totalSpent);
      lines.push("Budget Remaining," + Math.max(0, state.budgetMonthly - totalSpent));
      
      // Account balances
      lines.push("");
      lines.push("ACCOUNT BALANCES");
      lines.push("Account,Type,Balance");
      
      var totalBalance = 0;
      for (var acc in state.accounts) {
        var type = state.accountTypes[acc] || "other";
        var balance = state.accounts[acc] || 0;
        var displayBalance = type === "credit" ? -balance : balance;
        lines.push(acc + "," + type + "," + balance);
        totalBalance += displayBalance;
      }
      lines.push("");
      lines.push("Net Worth," + totalBalance);
      
      var csvContent = lines.join("\n");
      var fileName = "fintrack_pro_report_" + new Date().toISOString().slice(0, 10) + ".csv";
      
      // Create blob and download
      var blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      
      // For IE and Edge
      if (navigator.msSaveBlob) {
        navigator.msSaveBlob(blob, fileName);
        return;
      }
      
      var url = window.URL.createObjectURL(blob);
      var a = document.createElement("a");
      a.style.display = "none";
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      
      // Cleanup
      setTimeout(function() {
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
      }, 100);
    }
    
    // Attach export button event listener after DOM is ready
    document.getElementById("exportCSVBtn").onclick = function(e) {
      e.preventDefault();
      e.stopPropagation();
      downloadCSV();
      return false;
    };

    document.getElementById("resetData").addEventListener("click", () => {
      if (!confirm("Reset all data? This cannot be undone.")) return;
      state = structuredClone(initialState);
      saveState();
      renderAll();
      showScreen("home");
    });

    // Generate App Icon for iOS Home Screen
    function generateAppIcon() {
      const canvas = document.createElement('canvas');
      canvas.width = 180;
      canvas.height = 180;
      const ctx = canvas.getContext('2d');
      
      // Background gradient
      const bgGradient = ctx.createLinearGradient(0, 0, 180, 180);
      bgGradient.addColorStop(0, '#0f172a');
      bgGradient.addColorStop(0.5, '#0f293d');
      bgGradient.addColorStop(1, '#090918');
      
      // Draw rounded rectangle background
      ctx.beginPath();
      ctx.roundRect(0, 0, 180, 180, 40);
      ctx.fillStyle = bgGradient;
      ctx.fill();
      
      // Draw decorative coins/circles
      // Top right coin
      ctx.beginPath();
      ctx.arc(140, 40, 25, 0, Math.PI * 2);
      ctx.fillStyle = 'rgba(56, 189, 248, 0.2)';
      ctx.fill();
      ctx.strokeStyle = 'rgba(56, 189, 248, 0.4)';
      ctx.lineWidth = 2;
      ctx.stroke();
      
      // Second coin
      ctx.beginPath();
      ctx.arc(150, 70, 18, 0, Math.PI * 2);
      ctx.fillStyle = 'rgba(52, 211, 153, 0.2)';
      ctx.fill();
      ctx.strokeStyle = 'rgba(52, 211, 153, 0.4)';
      ctx.stroke();
      
      // Bottom left coin
      ctx.beginPath();
      ctx.arc(35, 140, 20, 0, Math.PI * 2);
      ctx.fillStyle = 'rgba(167, 139, 250, 0.2)';
      ctx.fill();
      ctx.strokeStyle = 'rgba(167, 139, 250, 0.4)';
      ctx.stroke();
      
      // Rupee symbol gradient
      const rupeeGradient = ctx.createLinearGradient(40, 50, 140, 130);
      rupeeGradient.addColorStop(0, '#38bdf8');
      rupeeGradient.addColorStop(0.5, '#34d399');
      rupeeGradient.addColorStop(1, '#a78bfa');
      
      // Draw Rupee symbol
      ctx.font = 'bold 90px -apple-system, BlinkMacSystemFont, sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillStyle = rupeeGradient;
      ctx.fillText('‚Çπ', 90, 85);
      
      // Draw decorative bars below
      const barGradient = ctx.createLinearGradient(50, 140, 130, 160);
      barGradient.addColorStop(0, '#38bdf8');
      barGradient.addColorStop(0.5, '#34d399');
      barGradient.addColorStop(1, '#a78bfa');
      
      ctx.beginPath();
      ctx.roundRect(60, 140, 60, 8, 4);
      ctx.fillStyle = barGradient;
      ctx.globalAlpha = 0.6;
      ctx.fill();
      
      ctx.beginPath();
      ctx.roundRect(50, 154, 80, 6, 3);
      ctx.globalAlpha = 0.4;
      ctx.fill();
      
      ctx.globalAlpha = 1;
      
      // Convert to PNG and set as icon
      const iconUrl = canvas.toDataURL('image/png');
      const iconLink = document.getElementById('appIcon');
      if (iconLink) {
        iconLink.href = iconUrl;
      }
    }
    
    // Generate icon on load
    generateAppIcon();

    // Theme toggle button
    document.getElementById("themeToggleBtn").addEventListener("click", toggleTheme);
    
    // Update theme UI on load
    updateThemeUI();

    // Initialize
    updateCategoryDropdown("expense");
    updateFormForType("expense");
    recalcAccounts();
    renderAll();
    showScreen("home");
  </script>
</body>
</html>
